"use strict";const e=require("./common/vendor.js"),a=require("./utils/request.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-forms"))()}Math||((()=>"./node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+(()=>"./node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js")+(()=>"./node-modules/@dcloudio/uni-ui/lib/uni-forms-item/uni-forms-item.js")+(()=>"./node-modules/@dcloudio/uni-ui/lib/uni-file-picker/uni-file-picker.js")+(()=>"./node-modules/@dcloudio/uni-ui/lib/uni-forms/uni-forms.js"))();const t={name:"ProductManage",options:{styleIsolation:"shared"}},o=Object.assign(t,{setup(t){e.onLoad((()=>{console.log("小程序页面加载"),b(),C()}));e.onShow((()=>{console.log("小程序页面显示")})),e.onReady((()=>{console.log("页面渲染完成"),setTimeout((()=>{console.log("编辑器初始化")}),500)}));const o=e.ref(1),i=e.reactive({basic:{category:"",categoryId:"",name:"",title:"",status:1,images:[]},details:"",detailImages:[],specs:[]}),s=e.ref(0);e.watch((()=>i.details),(e=>{console.log("内容已更新，长度:",null==e?void 0:e.length),s.value=Date.now()}));const l=e=>{i.details=i.details+e,s.value=Date.now()},n=()=>{e.index.chooseImage({count:1,success:async a=>{try{if(!a.tempFilePaths||0===a.tempFilePaths.length)return void e.index.showToast({title:"没有选择图片",icon:"none"});e.index.showLoading({title:"上传中..."});const o=a.tempFilePaths[0],l=e.index.getFileSystemManager();try{l.accessSync(o);const a=`<img src="${await c(o)}" style="max-width:100%;" />`;i.details=i.details+a,s.value=Date.now(),e.index.showToast({title:"图片插入成功",icon:"success"})}catch(t){console.error("文件访问错误:",t),e.index.showToast({title:"无法访问选中的图片",icon:"none"})}}catch(o){console.error("上传图片失败:",o),e.index.showToast({title:"图片上传失败",icon:"none"})}finally{e.index.hideLoading()}}})},c=async a=>{try{if(console.log("开始上传图片:",a),!a)throw new Error("临时文件路径不存在");const t=()=>new Promise(((t,o)=>{try{e.index.getFileSystemManager().access({path:a,success:()=>{e.index.uploadFile({url:"https://bgnc.online/api/file/upload",filePath:a,name:"file",header:{Authorization:`Bearer ${e.index.getStorageSync("token")}`},success:e=>{console.log("上传成功, 原始响应:",e);try{const a="string"==typeof e.data?JSON.parse(e.data):e.data;200===a.code?t(a.msg):o(new Error(a.msg||"上传失败"))}catch(a){o(new Error("响应解析失败"))}},fail:e=>{console.error("上传失败:",e),o(new Error("网络错误"))}})},fail:e=>{console.error("文件不存在:",a,e),o(new Error("临时文件不存在或已被删除"))}})}catch(i){console.error("文件系统错误:",i),o(new Error("文件系统错误"))}})),o=await t();return console.log("上传成功, 图片URL:",o),o}catch(t){throw console.error("上传图片错误:",t),e.index.showToast({title:"图片上传失败: "+(t.message||"未知错误"),icon:"none"}),t}},r=async a=>{try{console.log("选择商品图片",a);const{tempFilePaths:t,tempFiles:o}=a;if(!t||0===t.length)return void e.index.showToast({title:"没有选择图片",icon:"none"});e.index.showLoading({title:"上传中...",mask:!0});const s=e.index.getFileSystemManager(),l=t.map((async e=>{try{await new Promise(((a,t)=>{s.access({path:e,success:a,fail:a=>{console.error("文件不存在:",e,a),t(new Error("临时文件不存在或已被删除"))}})}));const a=await c(e);return{name:e.split("/").pop(),url:a}}catch(a){return console.error("文件访问失败:",e,a),null}})),n=(await Promise.all(l)).filter((e=>null!==e));if(0===n.length)throw new Error("所有图片上传失败");i.basic.images=[...i.basic.images,...n],e.index.hideLoading(),e.index.showToast({title:`成功上传${n.length}张图片`,icon:"success"})}catch(t){e.index.hideLoading(),e.index.showToast({title:"上传失败: "+(t.message||"未知错误"),icon:"none"})}},u=e=>{console.log("删除商品图片",e);const{index:a}=e;i.basic.images.splice(a,1)},d=async a=>{try{console.log("选择详情图片",a);const{tempFilePaths:t,tempFiles:o}=a;if(!t||0===t.length)return void e.index.showToast({title:"没有选择图片",icon:"none"});e.index.showLoading({title:"上传中...",mask:!0});const s=e.index.getFileSystemManager(),l=t.map((async e=>{try{await new Promise(((a,t)=>{s.access({path:e,success:a,fail:a=>{console.error("文件不存在:",e,a),t(new Error("临时文件不存在或已被删除"))}})}));const a=await c(e);return{name:e.split("/").pop(),url:a}}catch(a){return console.error("文件访问失败:",e,a),null}})),n=(await Promise.all(l)).filter((e=>null!==e));if(0===n.length)throw new Error("所有图片上传失败");i.detailImages=[...i.detailImages,...n],e.index.hideLoading(),e.index.showToast({title:`成功上传${n.length}张图片`,icon:"success"})}catch(t){e.index.hideLoading(),e.index.showToast({title:"上传失败: "+(t.message||"未知错误"),icon:"none"})}},p=e=>{console.log("删除详情图片",e);const{index:a}=e;i.detailImages.splice(a,1)},g=()=>{i.specs.push({id:null,name:"",value:"",price:"",stock:"",productId:""})},m=()=>{o.value>1&&o.value--},v=()=>{h()&&o.value<3&&(o.value++,y())},h=()=>{if(1===o.value){if(!i.basic.name)return e.index.showToast({title:"请输入商品名称",icon:"none"}),!1;if(!i.basic.title)return e.index.showToast({title:"请输入商品标题",icon:"none"}),!1}return!0},f=()=>{y(),e.index.showToast({title:"保存成功",icon:"success"})},y=()=>{try{const a=JSON.stringify(i);e.index.setStorageSync("product_draft",a),console.log("数据已保存到本地存储")}catch(a){console.error("保存到本地存储失败",a)}},b=()=>{try{const a=e.index.getStorageSync("product_draft");if(a){const e=JSON.parse(a);Object.assign(i,e),console.log("从本地存储恢复数据成功")}}catch(a){console.error("从本地存储恢复数据失败",a)}},w=e=>{i.basic.status=e.detail.value?1:0,console.log("商品上架状态:",i.basic.status)},x=()=>{i.basic={name:"",title:"",category:"",categoryId:"",status:1,images:[],skuid:""},i.details="",i.detailImages=[],i.specs=[{id:null,name:"",value:"",price:"",stock:"",productId:""}],o.value=1,G.value=!1,_.value=""},T=async()=>{try{if(!$())return;e.index.showLoading({title:"正在提交..."});let t="";i.basic.images&&i.basic.images.length>0&&(t=i.basic.images[0].url||i.basic.images[0]);let o="";i.detailImages&&i.detailImages.length>0&&(o=i.detailImages.map((e=>e.url||e)).join(","));const s=i.specs.map((e=>{const a={stock:parseInt(e.stock)||0,price:parseFloat(e.price)||0,spData:e.name+":"+e.value};return e.id&&(a.id=e.id),G.value&&_.value?a.productId=_.value:e.productId&&(a.productId=e.productId),a})),l={name:i.basic.name,categoryId:i.basic.categoryId||0,status:i.basic.status,description:i.basic.title,detailHtml:i.details,albumPics:o,indexPic:t,skus:s};let n;console.log("提交的商品数据:",JSON.stringify(l,null,2)),console.log("编辑模式:",G.value,"商品ID:",_.value),n=G.value?await a.request({url:"https://bgnc.online/api/product",method:"PUT",data:{...l,id:_.value}}):await a.request({url:"https://bgnc.online/api/product",method:"POST",data:l}),200===n.code?(e.index.showToast({title:G.value?"修改成功":"提交成功",icon:"success"}),x(),Y(),Z()):e.index.showToast({title:(null==n?void 0:n.message)||"提交失败，请检查数据",icon:"none"})}catch(t){console.error("提交商品出错:",t),e.index.showToast({title:"提交失败: "+(t.message||"未知错误"),icon:"none"})}finally{e.index.hideLoading()}},k=e.computed((()=>i.details&&i.details.includes("<b>")&&i.details.includes("</b>"))),I=e.computed((()=>i.details&&i.details.includes("<i>")&&i.details.includes("</i>"))),L=e.computed((()=>i.details&&i.details.includes("<u>")&&i.details.includes("</u>"))),P=e.computed((()=>i.details&&i.details.includes("<img"))),E=e.computed((()=>i.details&&(i.details.includes("<ul>")||i.details.includes("<ol>")))),S=()=>{if(!i.details)return"";const e=i.details.match(/<b>(.*?)<\/b>/g);return e?e.map((e=>e.replace(/<b>/g,"").replace(/<\/b>/g,""))).join(", "):"无"},j=()=>{if(!i.details)return"";const e=i.details.match(/<i>(.*?)<\/i>/g);return e?e.map((e=>e.replace(/<i>/g,"").replace(/<\/i>/g,""))).join(", "):"无"},z=()=>{if(!i.details)return"";const e=i.details.match(/<u>(.*?)<\/u>/g);return e?e.map((e=>e.replace(/<u>/g,"").replace(/<\/u>/g,""))).join(", "):"无"},D=()=>{if(!i.details)return 0;const e=i.details.match(/<img/g);return e?e.length:0},F=()=>{if(!i.details)return 0;const e=i.details.match(/<li>(.*?)<\/li>/g);return e?e.length:0},q=e.ref([]),M=e.ref(!1),A=e.ref(null),C=async()=>{M.value=!0;try{const t=await a.request({url:"https://bgnc.online/api/category/list",method:"GET"});console.log("获取的分类数据:",t),t&&t.data?(q.value=t.data.map((e=>({id:e.id||e.categoryId||e._id,name:e.name||e.categoryName}))),console.log("处理后的分类列表:",q.value)):(q.value=[],e.index.showToast({title:"获取分类失败",icon:"none"}))}catch(t){console.error("获取分类出错:",t),e.index.showToast({title:"获取分类失败: "+(t.message||"未知错误"),icon:"none"}),q.value=[{id:"1",name:"新鲜水果"},{id:"2",name:"时令蔬菜"},{id:"3",name:"北果南茶"},{id:"4",name:"坚果零食"},{id:"5",name:"冲饮茶品"}]}finally{M.value=!1}},N=()=>{A.value&&A.value.open("bottom"),0!==q.value.length||M.value||C()},O=()=>{A.value&&A.value.close()},$=()=>{if(1===o.value){if(!i.basic.categoryId)return e.index.showToast({title:"请选择商品类别",icon:"none"}),!1;if(!i.basic.name)return e.index.showToast({title:"请输入商品名称",icon:"none"}),!1;if(!i.basic.title)return e.index.showToast({title:"请输入商品标题",icon:"none"}),!1}else if(3===o.value)for(let a=0;a<i.specs.length;a++)if(!i.specs[a].price)return e.index.showToast({title:`请为规格 ${a+1} 设置价格`,icon:"none"}),!1;return!0},J=e.ref("list"),G=e.ref(!1),_=e.ref(null),B=e.ref([]),H=e.ref([]),V=e.ref(""),R=e.ref(1),U=e.ref(10),K=e.ref(0),Q=e.ref(!1),W=e.ref(!0),X=e.ref("");e.ref("add");const Y=async(t=!1)=>{if(!Q.value){Q.value=!0;try{const o={pageNum:R.value,pageSize:U.value,orderByColumn:"createTime",isAsc:"desc"};V.value.trim()&&(o.name=V.value.trim()),X.value&&(o.categoryId=X.value),console.log("正在获取商品列表，参数:",o);const i=await a.request({url:"https://bgnc.online/api/product/list",method:"GET",data:o});if(console.log("获取到的商品列表响应:",i),200===i.code){let e=i.data;Array.isArray(e)?B.value=t?[...B.value,...e]:e:e&&e.rows?(B.value=t?[...B.value,...e.rows]:e.rows,K.value=e.total||0):B.value=t?[...B.value,...e||[]]:e||[],H.value=[...B.value],console.log("处理后的商品列表:",H.value),W.value=t?B.value.length<K.value:!!Array.isArray(e)&&e.length>=U.value}else e.index.showToast({title:i.msg||"获取商品列表失败",icon:"none"})}catch(o){console.error("获取商品列表失败:",o),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{Q.value=!1}}},Z=()=>{J.value="list",0===B.value.length&&Y()},ee=()=>{J.value="edit"},ae=()=>{x(),G.value=!1,_.value=null,o.value=1,ee()},te=async t=>{try{Q.value=!0;const o=await a.request({url:`https://bgnc.online/api/product/${t}`,method:"DELETE"});200===o.code?(e.index.showToast({title:"删除成功",icon:"success"}),B.value=B.value.filter((e=>e.id!==t)),H.value=B.value):e.index.showToast({title:(null==o?void 0:o.message)||"删除失败",icon:"none"})}catch(o){console.error("删除商品失败:",o),e.index.showToast({title:"删除失败: "+(o.message||"未知错误"),icon:"none"})}finally{Q.value=!1}},oe=()=>{W.value&&!Q.value&&(R.value++,Y(!0))},ie=function(e,a){let t=null;return function(){t&&clearTimeout(t),t=setTimeout((()=>{e.apply(this,arguments),t=null}),a)}}((()=>{R.value=1,Y()}),500);e.onMounted((()=>{Y()}));const se=e=>J.value===e?"#4a90e2":"#666";return(t,s)=>e.e({a:e.p({type:"list",size:"18",color:se("list")}),b:e.n("list"===J.value?"active":""),c:e.o((e=>Z())),d:e.p({type:"plusempty",size:"18",color:se("edit")}),e:e.t(G.value?"修改商品":"添加商品"),f:e.n("edit"===J.value?"active":""),g:e.o((e=>ee())),h:"list"===J.value},"list"===J.value?e.e({i:e.p({type:"search",size:"16",color:"#999"}),j:e.o([e=>V.value=e.detail.value,(...a)=>e.unref(ie)&&e.unref(ie)(...a)]),k:V.value,l:e.f(H.value,((t,s,l)=>({a:t.indexPic||"/static/images/default-product.png",b:e.t(t.name),c:e.t(t.description),d:e.o((a=>(a=>{e.index.showToast({title:"查看商品: "+a.name,icon:"none"})})(t)),t.id),e:"38a84dee-3-"+l,f:e.o((s=>(async t=>{try{Q.value=!0;const s=await a.request({url:`https://bgnc.online/api/product/${t.id}`,method:"GET"});if(200===s.code&&s.data){console.log("111获取的商品数据:",s.data);const a=s.data;console.log("productData是",a),console.log("productData.skuList",a.skuList),i.basic.name=a.name,i.basic.title=a.description,i.basic.category=a.categoryName,i.basic.categoryId=a.categoryId,i.basic.status=a.status,a.indexPic&&(i.basic.images=[{url:a.indexPic}]),a.albumPics&&(i.detailImages=a.albumPics.split(",").map((e=>({url:e})))),i.details=a.detailHtml||"",i.specs=[],console.log("productData.skuList",a.skuList),a.skuList&&a.skuList.length>0?(console.log("使用skuList数据:",a.skuList),a.skuList.forEach((e=>{if(e.spData){const a=e.spData.split(":");2===a.length&&i.specs.push({id:e.id,name:a[0],value:a[1],price:e.price,stock:e.stock,productId:e.productId})}}))):a.skus&&a.skus.length>0&&(console.log("使用skus数据:",a.skus),a.skus.forEach((e=>{if(e.spData){const a=e.spData.split(":");2===a.length&&i.specs.push({id:e.id,name:a[0],value:a[1],price:e.price,stock:e.stock,productId:e.productId||t.id})}}))),0===i.specs.length&&i.specs.push({id:null,name:"",value:"",price:"",stock:""}),console.log("解析后的规格数据:",i.specs),G.value=!0,_.value=t.id,o.value=1,ee(),e.index.showToast({title:"已加载商品数据",icon:"success"})}else e.index.showToast({title:"获取商品详情失败",icon:"none"})}catch(s){console.error("获取商品详情失败:",s),e.index.showToast({title:"获取商品详情失败: "+(s.message||"未知错误"),icon:"none"})}finally{Q.value=!1}})(t)),t.id),g:"38a84dee-4-"+l,h:e.o((a=>(a=>{e.index.showModal({title:"确认删除",content:`确定要删除商品"${a.name}"吗？此操作不可恢复。`,confirmColor:"#ff4d4f",success:e=>{e.confirm&&te(a.id)}})})(t)),t.id),i:t.id}))),m:e.p({type:"compose",size:"16",color:"#4a90e2"}),n:e.p({type:"trash",size:"16",color:"#ff4d4f"}),o:e.p({type:"plusempty",size:"36",color:"#ddd"}),p:e.o(ae),q:B.value.length>0&&!Q.value&&W.value},B.value.length>0&&!Q.value&&W.value?{r:e.o(oe)}:{},{s:Q.value},Q.value?{t:e.p({type:"spinner-cycle",size:"24",color:"#999"})}:{},{v:0===B.value.length&&!Q.value},(0!==B.value.length||Q.value,{})):{},{w:"edit"===J.value},"edit"===J.value?{x:e.f(3,((a,t,i)=>({a:e.t(t+1),b:e.t(["基本信息","商品详情","规格设置"][t]),c:t,d:e.n(o.value===t+1?"active":"")})))}:{},{y:"edit"===J.value},"edit"===J.value?e.e({z:1===o.value},1===o.value?e.e({A:i.basic.category},i.basic.category?{B:e.t(i.basic.category)}:{},{C:e.p({type:"bottom",size:"14",color:"#999"}),D:e.o(N),E:e.p({type:"close",size:"20",color:"#666"}),F:e.o(O),G:e.f(q.value,((a,t,o)=>e.e({a:e.t(a.name),b:i.basic.category===a.name},i.basic.category===a.name?{c:"38a84dee-12-"+o+",38a84dee-10",d:e.p({type:"checkmarkempty",size:"18",color:"#4a90e2"})}:{},{e:t,f:i.basic.category===a.name?1:"",g:e.o((e=>(e=>{i.basic.category=e.name,console.log("选择的分类:",e),i.basic.categoryId=e.id,console.log("设置的categoryId:",i.basic.categoryId),O()})(a)),t)}))),H:M.value},(M.value,{}),{I:!M.value&&0===q.value.length},(M.value||q.value.length,{}),{J:e.sr(A,"38a84dee-10,38a84dee-8",{k:"categoryPopup"}),K:e.p({type:"bottom"}),L:e.p({label:"商品类别",required:!0}),M:i.basic.name,N:e.o((e=>i.basic.name=e.detail.value)),O:e.p({label:"商品名称",required:!0}),P:i.basic.title,Q:e.o((e=>i.basic.title=e.detail.value)),R:e.p({label:"商品标题",required:!0}),S:1===i.basic.status,T:e.o(w),U:e.t(1===i.basic.status?"已上架":"未上架"),V:e.p({label:"是否上架"}),W:e.o(r),X:e.o(u),Y:e.o((e=>i.basic.images=e)),Z:e.p({limit:"9","file-mediatype":"image","return-type":"array","image-styles":{width:"200rpx",height:"200rpx"},modelValue:i.basic.images}),aa:e.p({label:"商品图片"}),ab:e.p({modelValue:i.basic})}):{},{ac:2===o.value},2===o.value?e.e({ad:i.details,ae:e.o((e=>i.details=e.detail.value)),af:e.o((e=>l("<b>粗体文本</b>"))),ag:e.o((e=>l("<i>斜体文本</i>"))),ah:e.o((e=>l("<u>下划线文本</u>"))),ai:e.o((e=>l("<h3>标题文本</h3>"))),aj:e.o((e=>l("<ul><li>列表项1</li><li>列表项2</li></ul>"))),ak:e.o(n),al:i.details||"<p>暂无内容，请在上方输入内容</p>",am:k.value},k.value?{an:e.t(S())}:{},{ao:I.value},I.value?{ap:e.t(j())}:{},{aq:L.value},L.value?{ar:e.t(z())}:{},{as:P.value},P.value?{at:e.t(D())}:{},{av:E.value},E.value?{aw:e.t(F())}:{},{ax:e.o(d),ay:e.o(p),az:e.o((e=>i.detailImages=e)),aA:e.p({"file-mediatype":"image",mode:"grid","return-type":"array",limit:"20",modelValue:i.detailImages})}):{},{aB:3===o.value},3===o.value?{aC:e.f(i.specs,((a,t,o)=>({a:e.t(t+1),b:"38a84dee-19-"+o,c:e.o((e=>(e=>{console.log("删除规格",e),i.specs.splice(e,1)})(t)),t),d:a.name,e:e.o((e=>a.name=e.detail.value),t),f:a.value,g:e.o((e=>a.value=e.detail.value),t),h:a.price,i:e.o((e=>a.price=e.detail.value),t),j:a.stock,k:e.o((e=>a.stock=e.detail.value),t),l:t}))),aD:e.p({type:"close",size:"18",color:"#fff"}),aE:e.p({type:"plus",size:"16"}),aF:e.o(g)}:{}):{},{aG:"edit"===J.value},"edit"===J.value?e.e({aH:o.value>1},o.value>1?{aI:e.o(m)}:{},{aJ:e.o(f),aK:o.value<3},o.value<3?{aL:e.o(v)}:{aM:e.t(G.value?"保存修改":"提交商品"),aN:e.o(T)}):{})}});exports._sfc_main=o;

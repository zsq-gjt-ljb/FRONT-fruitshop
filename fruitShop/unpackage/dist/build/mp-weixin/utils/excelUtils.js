"use strict";const e=require("../common/vendor.js");exports.exportToUserSelectedLocation=o=>{try{const t=((o,t,s="Sheet1")=>{const n=e.utils.book_new();let c=[];t&&t.length>0&&c.push(t),o&&o.length>0&&(c=c.concat(o));const i=e.utils.aoa_to_sheet(c);return e.utils.book_append_sheet(n,i,s),n})(o.data,o.headers,"Sheet1"),s=e.writeSync(t,{bookType:"xlsx",type:"array"});if("undefined"!=typeof window&&window.Blob&&window.URL){const e=new Blob([s],{type:"application/octet-stream"}),t=URL.createObjectURL(e),n=document.createElement("a");return n.href=t,n.download=o.fileName||"export.xlsx",document.body.appendChild(n),n.click(),setTimeout((()=>{document.body.removeChild(n),URL.revokeObjectURL(t)}),100),void(o.success&&o.success())}const n=e.index.getFileSystemManager(),c=`${e.index.env.USER_DATA_PATH}/${o.fileName||"export.xlsx"}`;n.writeFileSync(c,s,"binary"),e.index.saveFile({tempFilePath:c,success:function(t){const s=t.savedFilePath;e.index.openDocument({filePath:s,showMenu:!0,success:function(){e.index.showToast({title:"文件已打开",icon:"success"}),o.success&&o.success(s)},fail:function(t){console.error("打开文件失败:",t),e.index.showToast({title:"文件已保存，但无法打开",icon:"none"}),o.success&&o.success(s)}})},fail:function(t){console.error("保存文件失败:",t),e.index.openDocument({filePath:c,showMenu:!0,success:function(){e.index.showToast({title:"文件已打开",icon:"success"}),o.success&&o.success(c)},fail:function(s){console.error("打开文件失败:",s),e.index.showToast({title:"导出失败，请重试",icon:"none"}),o.fail&&o.fail(t)}})}})}catch(t){console.error("导出Excel失败:",t),e.index.showToast({title:"导出Excel失败",icon:"none"}),o.fail&&o.fail(t)}},exports.getExcelFromApi=o=>{o.url?(e.index.showLoading({title:"正在获取数据..."}),e.index.request({url:o.url,method:o.method||"GET",data:o.data||{},header:{...o.header,"content-type":"application/json"},responseType:"arraybuffer",success:function(t){if(e.index.hideLoading(),200===t.statusCode){const s=((o,t={})=>{if(!(o&&o instanceof ArrayBuffer))return console.error("无效的Excel数据"),{error:"无效的Excel数据"};try{const s=e.readSync(o,{type:"array"}),n=s.SheetNames;if(0===n.length)return{error:"Excel文件中没有工作表"};let c=t.sheetName;c||(c=n[t.sheetIndex||0]||n[0]);const i=s.Sheets[c];return i?{sheets:n,data:e.utils.sheet_to_json(i,{header:!1!==t.header?1:void 0,raw:!0,defval:""}),sheetName:c}:{error:`找不到工作表: ${c}`}}catch(s){return console.error("解析Excel数据失败:",s),{error:"解析Excel数据失败: "+s.message}}})(t.data,o);s.error?(e.index.showToast({title:s.error,icon:"none"}),o.fail&&o.fail(s.error)):o.success&&o.success(s)}else{const s="获取数据失败: "+t.statusCode;e.index.showToast({title:s,icon:"none"}),o.fail&&o.fail(s)}},fail:function(t){e.index.hideLoading(),console.error("请求失败:",t),e.index.showToast({title:"网络请求失败",icon:"none"}),o.fail&&o.fail(t)},complete:function(){o.complete&&o.complete()}})):e.index.showToast({title:"接口地址不能为空",icon:"none"})};

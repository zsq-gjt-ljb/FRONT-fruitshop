"use strict";const e=require("../common/vendor.js"),t=()=>{const e=getCurrentPages(),t=e[e.length-1],o=`/${t.route}`,a=t.options;if(Object.keys(a).length>0){return`${o}?${Object.keys(a).map((e=>`${e}=${a[e]}`)).join("&")}`}return o},o=e=>["/api/user/profile","/api/addressbook","/api/order","/api/user","/api/cart"].some((t=>e.includes(t))),a=e=>Array.isArray(e)?e.map((e=>a(e))):e&&"object"==typeof e?Object.entries(e).reduce(((e,[t,o])=>(e[t]=t.toLowerCase().endsWith("id")&&"number"==typeof o?o.toString():a(o),e)),{}):e;exports.request=async(r={})=>{var n;try{console.log("发送请求到:",r.url),r.data&&console.log("请求数据:",r.data);const i=e.index.getStorageSync("token"),s=e.index.getStorageSync("isGuestMode"),d={"Content-Type":"application/json",Authorization:i?`Bearer ${i}`:"","X-Brand":"NanChaBeiGuo"},c=await e.index.request({url:r.url,method:r.method||"GET",data:r.data||{},header:{...d,...r.header}});if((null==(n=c.data)?void 0:n.data)&&(c.data.data=a(c.data.data)),200===c.statusCode)return c.data;if(401===c.statusCode){const a=o(r.url);if(s&&a){const o=t();throw e.index.navigateTo({url:"/pages/login/login?redirect="+encodeURIComponent(o)}),new Error("游客模式无法访问，请登录")}throw e.index.navigateTo({url:"/pages/login/login"}),new Error("未授权，请重新登录")}throw e.index.showToast({title:c.data.message||"请求失败",icon:"none"}),new Error(c.data.message||"请求失败")}catch(i){throw e.index.showToast({title:"网络错误",icon:"none"}),i}};

"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/request.js"),i=require("../../utils/area-data.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js"))();const t={__name:"edit",setup(t){const a=e.ref(""),n=e.ref({consignee:"",phone:"",region:"",detail:"",isDefault:!1}),l=e.ref(null),s=e.ref([0,0,0]),u=e.ref([]),d=e.ref([]),c=e.ref([]),v=e.ref([]);e.ref(!1);const r=e.ref(null),g=e.ref(null);e.ref(null);const p=e.ref("");let h=[];const f=()=>n.value.phone?/^1[3-9]\d{9}$/.test(n.value.phone)?(p.value="",!0):(p.value="请输入正确的手机号码",!1):(p.value="请输入手机号码",!1),m=()=>{h=[...s.value],console.log("打开地区选择器，当前值:",s.value),l.value.open()},x=()=>{s.value=h,console.log("取消地区选择，恢复值:",s.value),l.value.close()},y=()=>{if(3!==s.value.length)return void e.index.showToast({title:"请选择完整的地区信息",icon:"none"});const o=u.value[s.value[0]],i=d.value[s.value[1]],t=c.value[s.value[2]];o&&i&&t?(n.value.region=`${o.name}${i.name}${t.name}`,n.value.provinceCode=o.code,n.value.provinceName=o.name,n.value.cityCode=i.code,n.value.cityName=i.name,n.value.districtCode=t.code,n.value.districtName=t.name,console.log("确认选择地区:",n.value.region),l.value.close()):e.index.showToast({title:"请选择完整的地区信息",icon:"none"})},C=async()=>{if(n.value.consignee){if(f())if(n.value.region)if(n.value.detail){e.index.showLoading({title:"保存中..."});try{const i={consignee:n.value.consignee,phone:n.value.phone,provinceCode:n.value.provinceCode,provinceName:n.value.provinceName,cityCode:n.value.cityCode,cityName:n.value.cityName,districtCode:n.value.districtCode,districtName:n.value.districtName,detail:n.value.detail,isDefault:n.value.isDefault?1:0};if(r.value){i.id=r.value.id;const t=await o.request({url:"https://bgnc.online/api/addressbook/",method:"PUT",data:i});200===t.code?(e.index.showToast({title:"修改成功",icon:"success"}),g.value.close(),w()):e.index.showToast({title:t.msg||"修改失败",icon:"none"})}else{const t=await o.request({url:"https://bgnc.online/api/addressbook/",method:"POST",data:i});200===t.code?(e.index.showToast({title:"添加成功",icon:"success"}),g.value.close(),w()):e.index.showToast({title:t.msg||"添加失败",icon:"none"})}}catch(i){console.error("保存地址失败：",i),e.index.showToast({title:"保存失败，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}}else e.index.showToast({title:"请输入详细地址",icon:"none"});else e.index.showToast({title:"请选择所在地区",icon:"none"})}else e.index.showToast({title:"请输入收货人姓名",icon:"none"})},w=async()=>{try{e.index.showLoading({title:"加载中..."});const i=await o.request({url:"https://bgnc.online/api/addressbook/list",method:"GET"});if(200===i.code){v.value=i.data||[];const o=v.value.find((e=>e.isDefault));o?(a.value=o.id,e.index.setStorageSync("selectedAddressId",o.id)):v.value.length>0&&(a.value=v.value[0].id,e.index.setStorageSync("selectedAddressId",v.value[0].id))}else e.index.showToast({title:i.msg||"获取地址列表失败",icon:"none"})}catch(i){console.error("获取地址列表失败：",i),e.index.showToast({title:"获取地址列表失败",icon:"none"})}finally{e.index.hideLoading()}},T=()=>{r.value=null,n.value={consignee:"",phone:"",region:"",detail:"",isDefault:!1},g.value.open()},N=()=>{g.value.close()},b=e=>{const o=e.detail.value;if(s.value=o,o[0]!==h[0]){const e=u.value[o[0]];e&&(d.value=i.getCities(e.code),d.value.length>0?c.value=i.getDistricts(d.value[0].code):c.value=[],s.value=[o[0],0,0])}else if(o[1]!==h[1]){const e=d.value[o[1]];e&&(c.value=i.getDistricts(e.code),s.value=[o[0],o[1],0])}h=[...s.value]};return e.onMounted((()=>{u.value=i.getProvinces(),console.log("初始化省份数据:",u.value),u.value.length>0&&(d.value=i.getCities(u.value[0].code),console.log("初始化城市数据:",d.value),d.value.length>0&&(c.value=i.getDistricts(d.value[0].code),console.log("初始化区县数据:",c.value))),w();const o=e.index.getStorageSync("selectedAddressId");o&&(a.value=o)})),(t,D)=>e.e({a:e.f(v.value,((t,l,v)=>e.e({a:t.id===a.value},t.id===a.value?{b:"10615b9a-0-"+v,c:e.p({type:"checkmarkempty",size:"14",color:"#fff"})}:{},{d:t.id===a.value?1:"",e:e.t(t.consignee),f:e.t(t.phone),g:e.t(t.provinceName),h:e.t(t.cityName),i:e.t(t.districtName),j:e.t(t.detail),k:t.isDefault},(t.isDefault,{}),{l:e.o((o=>(o=>{r.value=o,n.value={consignee:o.consignee,phone:o.phone,region:`${o.provinceName}${o.cityName}${o.districtName}`,detail:o.detail,provinceCode:o.provinceCode,provinceName:o.provinceName,cityCode:o.cityCode,cityName:o.cityName,districtCode:o.districtCode,districtName:o.districtName,isDefault:1===o.isDefault};const t=u.value.findIndex((e=>e.code===o.provinceCode));if(-1!==t){d.value=i.getCities(o.provinceCode);const e=d.value.findIndex((e=>e.code===o.cityCode));if(-1!==e){c.value=i.getDistricts(o.cityCode);const a=c.value.findIndex((e=>e.code===o.districtCode));s.value=[t,e,-1!==a?a:0],h=[...s.value]}}e.nextTick$1((()=>{g.value.open()}))})(t)),t.id),m:e.o((i=>{return n=t.id,void e.index.showModal({title:"提示",content:"确定要删除该地址吗？",success:async i=>{if(i.confirm)try{e.index.showLoading({title:"删除中..."});const i=await o.request({url:`https://bgnc.online/api/addressbook/${n}`,method:"DELETE"});200===i.code?(e.index.showToast({title:"删除成功",icon:"success"}),a.value===n&&(a.value="",e.index.removeStorageSync("selectedAddressId")),w()):e.index.showToast({title:i.msg||"删除失败",icon:"none"})}catch(t){console.error("删除地址失败：",t),e.index.showToast({title:"删除失败，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}}});var n}),t.id),n:t.id,o:e.o((o=>(o=>{a.value=o.id,e.index.setStorageSync("selectedAddressId",o.id),e.index.showToast({title:"已选择该地址",icon:"success",duration:1500});const i=getCurrentPages(),t=i[i.length-2];t&&t.route.includes("checkout")&&setTimeout((()=>{e.index.navigateBack()}),1e3)})(t)),t.id)}))),b:e.o(T),c:e.t(r.value?"修改地址":"新增地址"),d:e.o(N),e:n.value.consignee,f:e.o((e=>n.value.consignee=e.detail.value)),g:e.o(f),h:n.value.phone,i:e.o((e=>n.value.phone=e.detail.value)),j:p.value},p.value?{k:e.t(p.value)}:{},{l:n.value.region},n.value.region?{m:e.t(n.value.region)}:{},{n:e.o(m),o:n.value.detail,p:e.o((e=>n.value.detail=e.detail.value)),q:n.value.isDefault,r:e.o((e=>n.value.isDefault=e.detail.value)),s:e.t(r.value?"修改":"保存"),t:e.o(C),v:e.sr(g,"10615b9a-1",{k:"formPopup"}),w:e.p({type:"bottom"}),x:e.o(x),y:e.o(y),z:e.f(u.value,((o,i,t)=>({a:e.t(o.name),b:i}))),A:e.f(d.value,((o,i,t)=>({a:e.t(o.name),b:i}))),B:e.f(c.value,((o,i,t)=>({a:e.t(o.name),b:i}))),C:"height: 80rpx;",D:s.value,E:e.o(b),F:e.sr(l,"10615b9a-2",{k:"regionPopup"}),G:e.p({type:"bottom"})})}};wx.createPage(t);

"use strict";const e=require("../../common/vendor.js"),l=require("../../common/assets.js"),a=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"category",setup(o){const n=e.ref([]),t=e.ref(null),u=e.ref(""),s=e.ref([]),c=e.ref(!1),i=e.ref(""),r=e.ref(!1),v=e.ref("default"),d=e.ref(!0);e.watch(i,(e=>{!e&&r.value&&(r.value=!1,p())}));const g=()=>{i.value="",r.value=!1,p()},p=()=>{t.value&&("all"===t.value.id?w():I(t.value.id))},m=()=>{if(!i.value.trim())return r.value=!1,void p();r.value=!0,f()},f=async()=>{try{c.value=!0,s.value=[];const e={name:i.value};t.value&&"all"!==t.value.id&&(e.categoryId=t.value.id);const l=Object.entries(e).map((([e,l])=>`${e}=${encodeURIComponent(l)}`)).join("&"),o=await a.request({url:`https://bgnc.online/api/product/list?${l}`,method:"GET"});console.log("搜索结果返回:",o),200===o.code&&(s.value=o.data,s.value=s.value.map((e=>(e.skus&&e.skus.length>0&&(e.price=e.skus[0].price),e))),S())}catch(l){console.error("搜索商品失败：",l),e.index.showToast({title:"搜索失败",icon:"none"})}finally{c.value=!1}};e.onShow((()=>{console.log("分类页面显示");try{const l=e.index.getStorageSync("selectedCategoryId");if(console.log("读取到的分类ID:",l),l){if(u.value=String(l),console.log("设置当前分类ID:",u.value),!n.value||0===n.value.length)return console.log("分类列表为空，加载分类列表"),void h();const e=n.value.find((e=>String(e.id)===String(l)));e?(console.log("找到匹配分类:",e.name),y(e)):(console.log("未找到匹配分类，重新加载分类列表"),h())}else n.value&&n.value.length>0?y(n.value[0]):h()}catch(l){console.error("读取选中分类ID失败:",l),h()}}));const h=async()=>{try{c.value=!0;const l=await a.request({url:"https://bgnc.online/api/category/list",method:"GET"});if(console.log("分类数据返回:",l),200===l.code){const a={id:"all",name:"全部商品"};if(n.value=[a,...l.data],console.log("分类列表加载完成，共",n.value.length,"项"),u.value){console.log("处理预选分类ID:",u.value);const l=n.value.find((e=>String(e.id)===String(u.value)));if(l)return console.log("找到ID匹配的分类:",l.name),y(l),void setTimeout((()=>{e.index.removeStorageSync("selectedCategoryId"),console.log("已清除预选分类ID")}),500);if("105"===u.value){console.log("尝试匹配低GI食品相关分类");const e=n.value.find((e=>e.name.includes("健康")||e.name.includes("糖")||e.name.includes("低")||e.name.includes("保健")));if(e)return console.log("找到低GI食品相关分类:",e.name),void y(e)}console.log("未找到匹配分类，使用默认分类")}console.log("选择默认分类"),y(n.value[0])}}catch(l){console.error("获取分类列表失败:",l),e.index.showToast({title:"加载分类失败",icon:"none"})}finally{c.value=!1}},y=e=>{console.log("选择分类:",e.name,e.id),t.value=e,u.value=e.id,i.value="",r.value=!1,"all"===e.id?w():I(e.id)},w=async()=>{try{c.value=!0,s.value=[];const e=await a.request({url:"https://bgnc.online/api/product/list",method:"GET"});console.log("所有商品返回:",e),200===e.code&&(s.value=e.data,s.value=s.value.map((e=>(e.skus&&e.skus.length>0&&(e.price=e.skus[0].price),e))),S())}catch(l){console.error("获取所有商品失败：",l),e.index.showToast({title:"获取商品失败",icon:"none"})}finally{c.value=!1}},I=async l=>{try{c.value=!0,s.value=[];const e=await a.request({url:`https://bgnc.online/api/product/list?categoryId=${l}`,method:"GET"});console.log("分类商品返回:",e),200===e.code&&(s.value=e.data,s.value=s.value.map((e=>(e.skus&&e.skus.length>0&&(e.price=e.skus[0].price),e))),S())}catch(o){console.error("获取分类商品失败：",o),e.index.showToast({title:"获取商品失败",icon:"none"})}finally{c.value=!1}};e.onMounted((()=>{console.log("分类页面已挂载"),h()}));const k=e=>{e===v.value?"price"===e&&(d.value=!d.value):(v.value=e,"price"===e&&(d.value=!0)),S()},S=()=>{if(0!==s.value.length)switch(v.value){case"price":s.value.sort(((e,l)=>{const a=parseFloat(e.price)||0,o=parseFloat(l.price)||0;return d.value?a-o:o-a}));break;case"sales":s.value.sort(((e,l)=>{const a=e.sales||0;return(l.sales||0)-a}))}};return(a,o)=>{var p;return e.e({a:e.f(n.value,((l,a,o)=>({a:e.t(l.name),b:l.id,c:e.n(u.value===l.id?"active":""),d:e.o((e=>y(l)),l.id)}))),b:e.t((null==(p=t.value)?void 0:p.name)||"全部商品"),c:e.p({type:"search",size:"18",color:"#4a90e2"}),d:e.o(m),e:i.value,f:e.o((e=>i.value=e.detail.value)),g:i.value},i.value?{h:e.p({type:"clear",size:"16",color:"#999"}),i:e.o(g)}:{},{j:"default"===v.value?1:"",k:e.o((e=>k("default"))),l:"sales"===v.value?1:"",m:e.o((e=>k("sales"))),n:"price"!==v.value||d.value?"":1,o:"price"===v.value&&d.value?1:"",p:"price"===v.value?1:"",q:e.o((e=>k("price"))),r:c.value},c.value?{}:e.e({s:e.f(s.value,((l,a,o)=>({a:l.indexPic||"/static/images/default-product.png",b:e.t(l.name),c:e.t(l.price||"暂无价格"),d:l.id,e:e.o((a=>{return o=l.id,e.index.navigateTo({url:`/pages/detail/detail?id=${o}`}),void console.log("跳转到商品详情:",o);var o}),l.id)}))),t:0===s.value.length},0===s.value.length?{v:l._imports_0$2,w:e.t(r.value?"未找到相关商品":"该分类暂无商品，敬请期待")}:{}))}}};wx.createPage(o);

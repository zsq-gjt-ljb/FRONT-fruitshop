"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"detail",setup(o){const r=e.ref([]),l=e.ref(""),n=e.ref(null),i=e.ref(null),u=e.ref(null),s=e.ref(!1),c=e.ref(""),d=e.ref(!1);let v=null;const g=e.ref(""),p=e.ref(!1),m=e.ref(""),h=e.ref(""),f=e.ref(""),y=e.ref(""),w=e.ref(""),T=e.ref([]),x=e.ref(!1),S=e.computed((()=>i.value?i.value:"暂无")),L=async()=>{if(l.value)try{e.index.showLoading({title:"加载中..."});const t=await a.request({url:`https://bgnc.online/api/order/${l.value}`,method:"GET"});if(console.log("获取订单详情结果:",JSON.stringify(t)),200===t.code){if(t.data){if(m.value=t.data.freightAmount||"0.00",h.value=t.data.payAmount||"",!h.value){const e=b(),t=parseFloat(m.value)||0,a=parseFloat(e)+t;h.value=a.toFixed(2)}let a=!1;if("已超时"===t.data.timeToLive||t.data.orderItemList&&t.data.orderItemList[0]&&"已超时"===t.data.orderItemList[0].timeToLive?(a=!0,g.value="已超时",p.value=!0):t.data.timeToLive&&(g.value=t.data.timeToLive),a&&0===t.data.status){return await N(-1)||(console.error("订单状态更新失败,重试一次"),await N(-1)),n.value=-1,void setTimeout((()=>{e.index.showToast({title:"订单已超时自动取消",icon:"none",duration:2e3}),setTimeout((()=>{$()}),1e3)}),500)}n.value=t.data.status,0!==t.data.status||a||t.data.createTime&&(i.value=t.data.createTime,M()),t.data.orderItemList&&Array.isArray(t.data.orderItemList)&&(r.value=t.data.orderItemList),t.data.createTime&&(i.value=t.data.createTime),t.data.payTime&&(u.value=A(new Date(t.data.payTime))),t.data.deliverySn&&(f.value=t.data.deliverySn,y.value=t.data.deliveryCompany||"顺丰速运",t.data.receiverPhone&&(w.value=t.data.receiverPhone.slice(-4),2===t.data.status&&z()))}}else e.index.showToast({title:t.msg||"获取订单详情失败",icon:"none"})}catch(t){console.error("获取订单详情失败:",t),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}},b=()=>{let e=0;return r.value&&r.value.length>0&&(e=r.value.reduce(((e,t)=>e+(parseFloat(t.productPrice)||0)),0)),e.toFixed(2)},$=()=>{const t=getCurrentPages();if(t.length>1){const e=t[t.length-2];e&&"pages/order/list"===e.route&&"function"==typeof e.$vm.getOrderList&&(e.$vm.pageNum=1,e.$vm.orderList=[],e.$vm.getOrderList())}e.index.navigateBack()},I=e=>{console.log("联系客服事件触发:",e.detail)},P=e=>{switch(parseInt(e)){case-1:return"已失效";case 0:return"待支付";case 1:return"待发货";case 2:return"待收货";case 3:return"已完成";case 4:return"退款/售后";default:return"未知状态"}},q=async()=>{if(!s.value)try{s.value=!0,e.index.showLoading({title:"正在获取支付信息..."});const o=await e.index.login();if(!o.code)throw new Error("获取微信登录code失败");console.log("获取到微信登录code:",o.code);const r=await a.request({url:"https://bgnc.online/api/notify/payment",method:"POST",data:{orderId:l.value,code:o.code}});if(console.log("获取到支付参数:",r),200!==r.code||!r.data)throw new Error(r.message||"获取支付参数失败");e.index.showLoading({title:"正在拉起支付..."}),await new Promise(((t,a)=>{e.index.requestPayment({provider:"wxpay",timeStamp:r.data.timeStamp,nonceStr:r.data.nonceStr,package:r.data.packageVal,signType:r.data.signType,paySign:r.data.paySign,success:e=>{console.log("支付成功",e),t(e)},fail:e=>{console.log("支付失败",e),a(e)}})})),e.index.showToast({title:"支付成功",icon:"success"});try{await a.request({url:"https://bgnc.online/api/order",method:"PUT",data:{id:l.value,status:1}}),console.log("订单状态已更新为待发货")}catch(t){console.error("更新订单状态失败:",t)}setTimeout((()=>{L()}),1e3)}catch(o){console.error("支付过程发生错误:",o),e.index.hideLoading(),o.errMsg&&o.errMsg.includes("cancel")?e.index.showToast({title:"用户取消支付",icon:"none"}):e.index.showToast({title:o.message||"支付失败",icon:"none"})}finally{e.index.hideLoading(),s.value=!1}},A=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`,k=e.computed((()=>(console.log("计算是否显示支付按钮, 当前状态:",n.value),0===n.value&&!d.value&&!p.value))),F=()=>{if(!i.value)return;const e=new Date(i.value.replace(/-/g,"/")),t=new Date(e.getTime()+6e5),a=new Date;if(a>=t)return c.value="00:00",d.value=!0,clearInterval(v),void D();const o=t-a,r=Math.floor(o/6e4),l=Math.floor(o%6e4/1e3);c.value=`${String(r).padStart(2,"0")}:${String(l).padStart(2,"0")}`},D=async()=>{console.log("订单已超时，准备更新订单状态");try{if(0!==n.value)return void console.log("订单状态不是待支付,无需更新");const t=await a.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:l.value,status:-1}});200===t.code?(console.log("订单状态更新为已失效"),n.value=-1,d.value=!0,e.index.showToast({title:"订单已超时自动取消",icon:"none",duration:2e3}),setTimeout((()=>{$()}),2e3)):(console.error("更新订单状态失败:",t.msg),setTimeout((async()=>{await N(-1)}),1e3))}catch(t){console.error("更新订单状态失败:",t),setTimeout((async()=>{await N(-1)}),1e3)}},M=()=>{v&&clearInterval(v),F(),v=setInterval((()=>{F()}),1e3)},N=async e=>{try{console.log(`更新订单状态为: ${e}`);const t=await a.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:l.value,status:e}});return 200===t.code?(console.log("订单状态更新成功"),n.value=e,!0):(console.error("订单状态更新失败:",t.msg),!1)}catch(t){return console.error("更新订单状态失败:",t),!1}},z=async()=>{if(f.value&&w.value){x.value=!0,T.value=[];try{const e=await a.request({url:`https://bgnc.online/api/order/route?phoneNumber=${w.value}&orderNumber=${f.value}`,method:"GET"});console.log("路由查询结果:",e),200===e.code&&e.data&&Array.isArray(e.data)?T.value=e.data:console.error("路由查询失败:",e.msg)}catch(t){console.error("路由查询失败:",t)}finally{x.value=!1}}else e.index.showToast({title:"缺少物流信息",icon:"none"})};e.onLoad((t=>{console.log("订单详情页面参数:",t),t.id?(l.value=t.id,L()):(e.index.showToast({title:"订单ID不存在",icon:"none"}),setTimeout((()=>{e.index.navigateBack()}),1500))})),e.onUnmounted((()=>{v&&(clearInterval(v),v=null)}));const E=()=>{$()},j=e=>e||0===e?parseFloat(e).toFixed(2):"0.00";return(a,o)=>e.e({a:e.t(l.value),b:null!=n.value},null!=n.value?e.e({c:0===n.value},0===n.value?{d:t._imports_0$6}:{},{e:e.t(P(n.value))}):{},{f:e.t(S.value),g:0===n.value&&p.value},0===n.value&&p.value?{h:e.t(g.value)}:{},{i:e.p({type:"shop",size:"18",color:"#3b78db"}),j:e.f(r.value,((t,a,o)=>e.e({a:t.productPic||"/static/images/default-product.png",b:e.t(t.productName),c:t.productAttr},t.productAttr?{d:e.t(t.productAttr)}:{},{e:e.t(t.productPrice),f:e.t(t.productQuantity),g:a}))),k:e.t(r.value.reduce(((e,t)=>e+(parseInt(t.productQuantity)||0)),0)),l:e.t(b()),m:e.t(j(m.value)),n:e.t(j(h.value)),o:e.t(i.value||"暂无"),p:u.value},u.value?{q:e.t(u.value)}:{},{r:0===n.value&&c.value&&!d.value},0===n.value&&c.value&&!d.value?{s:e.t(c.value)}:{},{t:0===n.value&&d.value},(0===n.value&&d.value,{}),{v:2===n.value&&f.value},2===n.value&&f.value?e.e({w:e.p({type:"truck",size:"18",color:"#3b78db"}),x:e.t(y.value||"顺丰速运"),y:e.t(f.value),z:e.p({type:"refresh",size:"14",color:"#3b78db"}),A:e.o(z),B:T.value.length>0},T.value.length>0?{C:e.f(T.value,((t,a,o)=>e.e({a:e.t(t.firstStatusName||"运输中"),b:e.t(t.acceptTime),c:e.t(t.acceptAddress),d:t.remark},t.remark?{e:e.t(t.remark)}:{},{f:a,g:0===a?1:""})))}:x.value?{E:e.p({type:"spinner-cycle",size:"24",color:"#ccc"})}:{},{D:x.value}):{},{F:e.o(E),G:k.value},k.value?{H:e.t(j(h.value)),I:e.o(q),J:s.value?1:""}:{},{K:e.o(I)})}};wx.createPage(o);

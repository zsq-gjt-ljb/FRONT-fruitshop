"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../utils/request.js"),o={__name:"list",setup(o){const r=e.ref([{name:"全部",value:""},{name:"待支付",value:0},{name:"待发货",value:1},{name:"待收货",value:2},{name:"已完成",value:3},{name:"退款/售后",value:4},{name:"已失效",value:-1}]),i=e.ref(""),l=e.ref([]),s=e.ref(1),n=e.ref(10),u=e.ref(!0),c=e.ref(!1),d=async(t=i.value,o=!1)=>{if(o&&(l.value=[],s.value=1,u.value=!0),u.value||o){c.value=!0,console.log("请求订单列表数据，页码：",s.value,"状态：",t);try{const r=await a.request({url:"https://bgnc.online/api/order/list",method:"GET",data:{pageNum:s.value,pageSize:n.value,status:t}});if(console.log("获取订单列表结果:",JSON.stringify(r)),200===r.code&&r.data){let e=[];if(Array.isArray(r.data))e=r.data;else if(r.data.list&&Array.isArray(r.data.list))e=r.data.list;else if("object"==typeof r.data)for(const t in r.data)if(Array.isArray(r.data[t])){e=r.data[t];break}if(console.log("解析后的订单数据:",JSON.stringify(e)),e.length>0){const t=await Promise.all(e.map((async e=>{const t=JSON.parse(JSON.stringify(e));if(0===t.status){let e=!1;if(t.orderItemList&&t.orderItemList.length>0)for(const a of t.orderItemList)if("已超时"===a.timeToLive){e=!0;break}if("已超时"===t.timeToLive&&(e=!0),!e&&t.createTime){const a=g(t.createTime);if(t.timeToLive=a,t.orderItemList&&t.orderItemList.length>0)for(let e=0;e<t.orderItemList.length;e++)t.orderItemList[e].timeToLive=a;"已超时"===a&&(e=!0)}if(e)try{const e=await a.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:t.id,status:-1}});200===e.code?(console.log(`订单 ${t.id} 更新为已失效状态`),t.status=-1):console.error(`订单 ${t.id} 状态更新失败:`,e.msg)}catch(o){console.error(`更新订单 ${t.id} 状态失败:`,o)}}return t})));o||1===s.value?l.value=t:l.value=[...l.value,...t],t.length<n.value?u.value=!1:(s.value+=1,u.value=!0)}else u.value=!1,(o||1===s.value)&&(l.value=[])}else e.index.showToast({title:r.msg||"获取订单列表失败",icon:"none"})}catch(r){console.error("获取订单列表失败:",r),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{c.value=!1,e.index.stopPullDownRefresh()}}else console.log("没有更多数据了")},v=()=>{u.value&&!c.value&&d()},m=e=>{const t=void 0!==e.displayStatus?e.displayStatus:e.status;switch(parseInt(t)){case-1:return"已失效";case 0:return"待支付";case 1:return"待发货";case 2:return"待收货";case 3:return"已完成";case 4:return"退款/售后";default:return"未知状态"}},f=t=>{e.index.navigateTo({url:`/pages/order/detail?id=${t}`})};e.onLoad((e=>{if(console.log("订单列表页面参数:",e),void 0!==e.status){const t=""===e.status?"":parseInt(e.status);i.value=t;r.value.find((e=>e.value===t))||(i.value="")}})),e.onShow((()=>{console.log("订单列表页面显示,刷新数据"),s.value=1,l.value=[],u.value=!0,d()})),e.onPullDownRefresh((()=>{s.value=1,l.value=[],u.value=!0,d()})),e.onReachBottom((()=>{v()})),e.onMounted((()=>{console.log("订单列表页面已加载")}));const g=e=>{if(!e)return"";const t=new Date(e),a=new Date(t.getTime()+18e5),o=new Date;if(o>=a)return"已超时";const r=a.getTime()-o.getTime(),i=Math.floor(r/6e4),l=Math.floor(r%6e4/1e3);return`${i.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`};let h=null;return e.onMounted((()=>{h=setInterval((()=>{(async()=>{if(l.value&&0!==l.value.length)for(let t=0;t<l.value.length;t++){const o=l.value[t];if(0===o.status){const r=g(o.createTime);if(o.orderItemList&&o.orderItemList.length>0)for(let e=0;e<o.orderItemList.length;e++)l.value[t].orderItemList[e].timeToLive=r;if(l.value[t].timeToLive=r,"已超时"===r)try{const e=await a.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:o.id,status:-1}});200===e.code?(console.log(`列表中订单 ${o.id} 已超时，状态更新为已失效`),l.value[t].status=-1,l.value[t].timeToLive=""):console.error(`列表中订单 ${o.id} 状态更新失败:`,e.msg)}catch(e){console.error(`列表中更新订单 ${o.id} 状态失败:`,e)}}else if(l.value[t].timeToLive="",o.orderItemList&&o.orderItemList.length>0)for(let e=0;e<o.orderItemList.length;e++)l.value[t].orderItemList[e].timeToLive=""}})()}),1e3)})),e.onUnmounted((()=>{h&&(clearInterval(h),h=null)})),(o,n)=>e.e({a:e.f(r.value,((t,a,o)=>({a:e.t(t.name),b:a,c:e.n(i.value===t.value?"active":""),d:e.o((e=>(async e=>{i.value!==e&&(i.value=e,s.value=1,l.value=[],u.value=!0,await d(e,!0))})(t.value)),a)}))),b:l.value.length>0},l.value.length>0?{c:e.f(l.value,((t,o,r)=>e.e({a:e.t(t.id),b:e.t(m(t)),c:0===t.status&&t.timeToLive},0===t.status&&t.timeToLive?{d:e.t(t.timeToLive)}:{},{e:e.f(t.orderItemList,((t,a,o)=>e.e({a:t.productPic,b:e.t(t.productName),c:t.productAttr},t.productAttr?{d:e.t(t.productAttr)}:{},{e:e.t(t.productPrice),f:e.t(t.productQuantity),g:t.id}))),f:e.t(t.receiverName),g:e.t(t.receiverPhone),h:e.t(t.receiverProvince),i:e.t(t.receiverCity),j:e.t(t.receiverRegion),k:e.t(t.receiverDetailAddress),l:t.deliveryCompany},t.deliveryCompany?{m:e.t(t.deliveryCompany)}:{},{n:e.t(t.totalAmount),o:e.t(t.freightAmount),p:e.t(t.payAmount),q:2===t.status},2===t.status?{r:e.o((o=>(async t=>{e.index.showModal({title:"确认收货",content:"确认已收到商品吗？",success:async o=>{if(o.confirm)try{const o=await a.request({url:`https://bgnc.online/api/order/receive/${t}`,method:"PUT"});200===o.code?(e.index.showToast({title:"确认收货成功",icon:"success"}),s.value=1,l.value=[],d()):e.index.showToast({title:o.message||"操作失败",icon:"none"})}catch(r){console.error("确认收货失败:",r),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}}})})(t.id)),t.id)}:{},{s:4===t.status},4===t.status?{t:e.o((e=>f(t.id)),t.id)}:{},{v:t.id,w:e.o((e=>f(t.id)),t.id)})))}:{d:t._imports_0$5},{e:u.value&&l.value.length>0},u.value&&l.value.length>0?e.e({f:c.value},c.value?{}:{g:e.o(v)}):{})}};wx.createPage(o);

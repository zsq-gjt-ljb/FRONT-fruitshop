"use strict";const e=require("../../../common/vendor.js"),t=require("../../../utils/request.js"),a=require("../../../utils/excelUtils.js");if(!Array){(e.resolveComponent("uni-popup")+e.resolveComponent("uni-icons"))()}Math||((()=>"../../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js")+(()=>"../../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js"))();const o={__name:"OrderManage",setup(o){const n=e.ref(!1),l=e.ref(0),s=e.ref(!1),r=["全部状态","已失效","待发货","待收货","已完成","退款/售后"],i=e.ref(0),u=e.ref([]),c=e.ref(0),d=e.ref(10),v=e.ref(1),p=e.computed((()=>Math.ceil(c.value/d.value)||1)),g=e.ref(null),h=e.ref(null),f=e.ref(null),m=e.ref(""),x=e.ref(0),w=e.ref(0),y=e.ref({trackingNo:""}),T=e=>{i.value=e.detail.value},$=async()=>{try{e.index.showLoading({title:"加载中"});let a=`https://bgnc.online/api/order/all?pageNum=${v.value}&pageSize=${d.value}&orderByColumn=createTime&isAsc=desc`;if(i.value>0){a+=`&status=${{1:-1,2:1,3:2,4:3,5:4}[i.value]}`}const o=await t.request({url:a,method:"GET"});200===o.code&&o.data?(console.log("订单数据:",o.data),o.data.rows&&Array.isArray(o.data.rows)&&(u.value=o.data.rows.filter((e=>0!==e.status)),c.value=o.data.total||0)):e.index.showToast({title:o.msg||"获取订单列表失败",icon:"none"})}catch(a){console.error("获取订单列表失败",a),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}},b=()=>{v.value=1,$()},k=()=>{i.value=0,v.value=1,$()},L=()=>{v.value>1&&(v.value--,$())},S=()=>{v.value<p.value&&(v.value++,$())},N=e=>{switch(parseInt(e)){case-1:return"已失效";case 1:return"待发货";case 2:return"待收货";case 3:return"已完成";case 4:return"退款/售后";default:return"未知状态"}},P=e=>{switch(parseInt(e)){case-1:return"status-invalid";case 1:return"status-pending-delivery";case 2:return"status-pending-receipt";case 3:return"status-completed";case 4:return"status-after-sale";default:return"status-unknown"}},q=()=>{g.value.close()},A=async()=>{if(y.value.trackingNo.trim())try{e.index.showLoading({title:"处理中"});const a=await t.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:m.value,status:2,deliverySn:y.value.trackingNo}});200===a.code?(e.index.showToast({title:"发货成功",icon:"success"}),g.value.close(),$()):e.index.showToast({title:a.msg||"发货失败",icon:"none"})}catch(a){console.error("发货失败",a),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}else e.index.showToast({title:"请输入物流单号",icon:"none"})},j=e=>{if(!e)return"暂无";try{const t=new Date(e.replace(" ","T")),a=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),l=t.getHours().toString().padStart(2,"0");return`${a}-${o}-${n} ${l}:${t.getMinutes().toString().padStart(2,"0")}`}catch(t){return console.error("日期格式化错误:",t,e),e}},C=e=>e?`${e.receiverProvince}${e.receiverCity}${e.receiverRegion} ${e.receiverDetailAddress}`:"暂无";e.onMounted((()=>{$(),console.log("弹窗引用:",{shipPopup:g.value,statusPopup:h.value,exportPopup:f.value})}));const M=async()=>{n.value||(s.value=!0,e.nextTick$1((()=>{f.value?f.value.open():(console.error("导出弹窗组件引用不存在"),e.index.showToast({title:"打开导出选项失败",icon:"none"}))})))},D=async()=>{try{n.value=!0,s.value=!1,f.value&&f.value.close();let t="https://bgnc.online/api/order/excel";if(l.value>0){t+=`?status=${{1:-1,2:1,3:2,4:3,5:4}[l.value]}`}a.getExcelFromApi({url:t,method:"GET",header:{"content-type":"application/vnd.ms-excel"},success:t=>{console.log("Excel数据解析成功:",t),a.exportToUserSelectedLocation({data:t.data,fileName:`订单数据_${I()}_${Date.now()}.xlsx`,success:()=>{console.log("文件导出成功")},fail:t=>{console.error("文件导出失败:",t),e.index.showToast({title:"导出失败，请重试",icon:"none"})}})},fail:t=>{console.error("获取Excel数据失败:",t),e.index.showToast({title:"导出失败，请重试",icon:"none"})},complete:()=>{n.value=!1}})}catch(t){console.error("导出订单失败:",t),e.index.showToast({title:"导出失败，请重试",icon:"none"}),n.value=!1}},E=()=>{s.value=!1,f.value&&f.value.close()},I=()=>{if(0===l.value)return"全部";return["全部","已失效","待发货","待收货","已完成","退款售后"][l.value]},U=()=>{h.value.close()},_=async()=>{if(x.value!==w.value)try{e.index.showLoading({title:"处理中"});const a=await t.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:m.value,status:x.value}});200===a.code?(e.index.showToast({title:"状态修改成功",icon:"success"}),h.value.close(),$()):e.index.showToast({title:a.msg||"状态修改失败",icon:"none"})}catch(a){console.error("状态修改失败",a),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{e.index.hideLoading()}else h.value.close()};return(t,a)=>e.e({a:e.t(r[i.value]),b:r,c:i.value,d:e.o(T),e:e.o(b),f:e.o(k),g:e.t(n.value?"导出中...":"导出"),h:e.o(M),i:n.value,j:e.f(u.value,((t,a,o)=>{return e.e({a:e.t(N(t.status)),b:e.n(P(t.status)),c:e.o((e=>{return a=t.id,o=t.status,m.value=a,x.value=parseInt(o),w.value=parseInt(o),void h.value.open();var a,o}),t.id),d:e.t(j(t.createTime)),e:t.timeToLive},t.timeToLive?{f:e.t(t.timeToLive)}:{},{g:e.t((l=t.id,l?l.length<=12?l:l.substring(0,6)+"..."+l.substring(l.length-6):"暂无")),h:e.o((a=>(t=>{e.index.setClipboardData({data:t,success:()=>{e.index.showToast({title:"订单号已复制",icon:"success"})}})})(t.id)),t.id),i:e.t(t.receiverName),j:e.t((n=t.receiverPhone,n?n.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"暂无")),k:e.t(t.payAmount),l:e.t(t.freightAmount),m:e.t(C(t)),n:e.o((a=>(t=>{e.index.navigateTo({url:`/pages/order/detail?id=${t}&admin=true`})})(t.id)),t.id),o:0===t.status||1===t.status},0===t.status||1===t.status?{p:e.o((e=>(e=>{m.value=e,y.value={trackingNo:""},g.value.open()})(t.id)),t.id)}:{},{q:t.id});var n,l})),k:0===u.value.length},(u.value.length,{}),{l:e.t(c.value),m:e.t(d.value),n:v.value<=1,o:e.o(L),p:e.t(v.value),q:e.t(p.value),r:v.value>=p.value,s:e.o(S),t:y.value.trackingNo,v:e.o((e=>y.value.trackingNo=e.detail.value)),w:e.o(q),x:e.o(A),y:e.sr(g,"2b3493e8-0",{k:"shipPopup"}),z:e.p({type:"center"}),A:e.f(["待发货","待收货","已完成","退款/售后"],((t,a,o)=>({a:e.n(`status-dot-${a+1}`),b:e.t(t),c:a,d:e.n({active:x.value===a+1}),e:e.o((e=>(e=>{x.value=e})(a+1)),a)}))),B:e.o(U),C:e.o(_),D:e.sr(h,"2b3493e8-1",{k:"statusPopup"}),E:e.p({type:"center"}),F:e.t(r[l.value]),G:e.p({type:"bottom",size:"14",color:"#666"}),H:r,I:l.value,J:e.o((e=>l.value=e.detail.value)),K:e.o(E),L:e.o(D),M:e.sr(f,"2b3493e8-2",{k:"exportPopup"}),N:e.p({type:"center"})})}};wx.createComponent(o);

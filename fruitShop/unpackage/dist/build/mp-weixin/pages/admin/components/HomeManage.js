"use strict";const e=require("../../../common/vendor.js"),o=require("../../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"HomeManage",setup(t){const n=e.ref([]),i=e.ref([]),a=e.ref([]),s=e.ref(""),l=e.ref(!1);let c=null;e.onMounted((()=>{console.log("HomeManage组件已加载"),u().then((()=>{console.log("产品列表加载完成，开始加载轮播图和首页商品"),f(!0)})),d()})),e.onShow((()=>{console.log("HomeManage页面显示"),f(!0),d()})),e.onHide((()=>{console.log("HomeManage页面隐藏"),r()})),e.onUnmounted((()=>{console.log("HomeManage组件卸载"),r()}));const d=()=>{r(),c=setInterval((()=>{console.log("执行自动检查..."),u().then((()=>{if(i.value.length>0){const e=new Set(i.value.map((e=>String(e.id))));g(e)}}))}),18e4)},r=()=>{c&&(clearInterval(c),c=null)},u=async()=>{try{l.value=!0;const t=await o.request({url:"https://bgnc.online/api/product/list",method:"GET"});if(200===t.code){console.log("result是",t),i.value=t.data||[];const e=new Set(i.value.map((e=>String(e.id))));console.log("有效商品ID列表:",e),g(e)}else i.value=[],e.index.showToast({title:t.message||"获取商品失败",icon:"none"})}catch(t){console.error("获取商品列表失败:",t),e.index.showToast({title:"网络错误",icon:"none"})}finally{l.value=!1}},g=async o=>{const t=n.value.filter((e=>!o.has(String(e.productId)))),i=a.value.filter((e=>!o.has(String(e.productId))));if(console.log("无效轮播图数量:",t.length,"无效首页商品数量:",i.length),t.length>0||i.length>0)try{for(const e of t)console.log("清理无效轮播图:",e.id,e.name),await x(e.id,!0);for(const e of i)console.log("清理无效首页商品:",e.id,e.name),await y(e.id,!0);await f(),(t.length>0||i.length>0)&&e.index.showToast({title:`已清理${t.length+i.length}个无效商品`,icon:"none",duration:2e3})}catch(s){console.error("清理无效商品失败:",s)}},h=()=>{if(!s.value)return void u();const e=s.value.toLowerCase();i.value=i.value.filter((o=>o.name.toLowerCase().includes(e)))},m=e=>{const o=String(e);return n.value.some((e=>String(e.productId)===o))},p=e=>{const o=String(e);return a.value.some((e=>String(e.productId)===o))},w=async()=>{try{const e=await o.request({url:"https://bgnc.online/api/productmarket/list/1",method:"GET"});200===e.code?(console.log("原始轮播数据:",e.data),n.value=(e.data||[]).map((e=>({id:e.id,productId:e.productId,name:e.name||"",indexPic:e.imgUrl||""}))),console.log("处理后的轮播数据:",n.value)):n.value=[]}catch(e){console.error("加载轮播图失败:",e),n.value=[]}},v=async()=>{try{console.log("开始加载首页商品数据");const e=await o.request({url:"https://bgnc.online/api/productmarket/list/0",method:"GET"});console.log("首页商品接口返回:",e),200===e.code?(a.value=(e.data||[]).map((e=>({id:e.id,productId:e.productId,name:e.name||"",indexPic:e.imgUrl||"",price:e.price}))),console.log("处理后的首页商品数据:",a.value)):(console.log("首页商品接口返回异常:",e.code,e.message),a.value=[])}catch(e){console.error("加载首页商品失败:",e),a.value=[]}},f=async(o=!1)=>{e.index.showLoading({title:"刷新中..."});try{if(await Promise.all([w(),v()]),o&&i.value.length>0){const e=new Set(i.value.map((e=>String(e.id))));await g(e)}else e.index.showToast({title:"数据已刷新",icon:"success"})}catch(t){console.error("刷新数据失败:",t),e.index.showToast({title:"刷新失败",icon:"none"})}finally{e.index.hideLoading()}},x=async(t,n=!1)=>{try{n||e.index.showLoading({title:"删除中..."});const i=await o.request({url:`https://bgnc.online/api/productmarket/${t}`,method:"DELETE"});200===i.code?(await w(),n||e.index.showToast({title:"已从轮播图移除",icon:"success"})):n||e.index.showToast({title:i.message||"删除失败",icon:"none"})}catch(i){console.error("删除轮播图失败:",i),n||e.index.showToast({title:"删除失败: "+(i.message||"未知错误"),icon:"none"})}finally{n||e.index.hideLoading()}},y=async(t,n=!1)=>{try{n||e.index.showLoading({title:"删除中..."});const i=await o.request({url:`https://bgnc.online/api/productmarket/${t}`,method:"DELETE"});200===i.code?(await v(),n||e.index.showToast({title:"已从首页移除",icon:"success"})):n||e.index.showToast({title:i.message||"删除失败",icon:"none"})}catch(i){console.error("删除首页商品失败:",i),n||e.index.showToast({title:"删除失败: "+(i.message||"未知错误"),icon:"none"})}finally{n||e.index.hideLoading()}};return(t,l)=>e.e({a:e.p({type:"reload",size:"16",color:"#4a90e2"}),b:e.o(f),c:e.f(n.value,((o,t,n)=>({a:o.indexPic||"/static/images/default-product.png",b:e.t(o.name),c:"efbd98c2-1-"+n,d:e.o((e=>x(o.id)),t),e:t}))),d:e.p({type:"trash",size:"16",color:"#ff4d4f"}),e:0===n.value.length},(n.value.length,{}),{f:e.f(a.value,((o,t,n)=>({a:o.indexPic||"/static/images/default-product.png",b:e.t(o.name),c:"efbd98c2-2-"+n,d:e.o((e=>y(o.id)),t),e:t}))),g:e.p({type:"trash",size:"16",color:"#ff4d4f"}),h:0===a.value.length},(a.value.length,{}),{i:e.p({type:"search",size:"16",color:"#999"}),j:e.o([e=>s.value=e.detail.value,h]),k:s.value,l:e.o(u),m:e.f(i.value,((t,s,l)=>({a:t.indexPic||"/static/images/default-product.png",b:e.t(t.name),c:e.t(t.price),d:e.t(m(t.id)?"已是轮播":"添加轮播"),e:e.o((a=>(async t=>{if(m(t.id))return void e.index.showToast({title:"该商品已在轮播图中",icon:"none"});if(!i.value.some((e=>String(e.id)===String(t.id))))return e.index.showToast({title:"该商品已被删除，请刷新列表",icon:"none"}),void(await u());try{e.index.showLoading({title:"添加中..."});const i=await o.request({url:"https://bgnc.online/api/productmarket",method:"POST",data:{productId:t.id,status:1,productName:t.name,imgUrl:t.indexPic}});200===i.code?(await w(),console.log("轮播图添加成功，刷新后数量:",n.value.length),e.index.showToast({title:"添加轮播图成功",icon:"success"})):e.index.showToast({title:i.message||"添加失败",icon:"none"})}catch(a){console.error("添加轮播图失败:",a),e.index.showToast({title:"添加失败: "+(a.message||"未知错误"),icon:"none"})}finally{e.index.hideLoading()}})(t)),t.id),f:m(t.id),g:e.t(p(t.id)?"已在首页":"添加首页"),h:e.o((n=>(async t=>{if(p(t.id))return void e.index.showToast({title:"该商品已在首页中",icon:"none"});if(!i.value.some((e=>String(e.id)===String(t.id))))return e.index.showToast({title:"该商品已被删除，请刷新列表",icon:"none"}),void(await u());try{e.index.showLoading({title:"添加中..."});const n=await o.request({url:"https://bgnc.online/api/productmarket",method:"POST",data:{productId:t.id,status:0,productName:t.name,imgUrl:t.indexPic}});200===n.code?(await v(),console.log("首页商品添加成功，刷新后数量:",a.value.length),e.index.showToast({title:"添加首页商品成功",icon:"success"})):e.index.showToast({title:n.message||"添加失败",icon:"none"})}catch(n){console.error("添加首页商品失败:",n),e.index.showToast({title:"添加失败: "+(n.message||"未知错误"),icon:"none"})}finally{e.index.hideLoading()}})(t)),t.id),i:p(t.id),j:t.id}))),n:0===i.value.length},(i.value.length,{}))}};wx.createComponent(t);

"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"checkout",setup(t){const a=e.ref([]),n=e.ref([]),i=e.ref(null),l=e.ref(""),s=e.ref(0),r=e.ref(""),c=e.ref("cart");e.onLoad((e=>{console.log("结算页面参数:",e),"buyNow"===e.type&&(c.value="buyNow"),u()}));const u=()=>{const o=e.index.getStorageSync("isGuestMode"),t=e.index.getStorageSync("token");if(o&&!t){const o="/"+getCurrentPages()[getCurrentPages().length-1].route;return e.index.navigateTo({url:"/pages/login/login?redirect="+encodeURIComponent(o),success:()=>{e.index.showToast({title:"请先登录后再结算",icon:"none",duration:2e3})}}),!0}return!1},d=async()=>{try{const a=await o.request({url:"https://bgnc.online/api/addressbook/list",method:"GET"});if(200===a.code){n.value=a.data||[],console.log("获取到的地址列表:",JSON.stringify(n.value));const l=e.index.getStorageSync("selectedAddressId");if(console.log("已保存的选择地址ID:",l),l)try{const e=await o.request({url:`https://bgnc.online/api/addressbook/${l}`,method:"GET"});if(200===e.code&&e.data)return console.log("通过API获取的地址详情:",e.data),void(i.value=e.data);console.error("获取地址详情失败:",e.message)}catch(t){console.error("获取地址详情API错误:",t)}const s=n.value.find((e=>e.isDefault));s?i.value=s:n.value.length>0&&(i.value=n.value[0]),console.log("最终选择的地址:",i.value)}}catch(t){console.error("获取地址列表失败:",t)}},g=e.computed((()=>a.value.reduce(((e,o)=>e+parseFloat(o.price)*o.quantity),0))),v=e.ref([]),p=e.computed((()=>{if(!r.value||0===v.value.length)return 10;const e=v.value.find((e=>e.memberLevel===Number(r.value)));return e?e.discount:10})),h=e.computed((()=>{if(p.value>=10)return 0;const e=(10-p.value)/10,o=g.value*e;return console.log("原始价格:",g.value,"折扣率:",e,"折扣金额:",o),o>0&&o<.01?.01:o})),m=e.computed((()=>{const e="string"==typeof r.value?r.value:String(r.value);if(v.value.length>0){const o=v.value.find((o=>o.memberLevel===Number(e)));if(o){const t=o.discount.toFixed(1);return o.discount>=10?`V${e}会员(无折扣)`:`V${e}会员(${t}折)`}}return`V${e}会员`})),y=e.computed((()=>(g.value>=88?s.value=0:s.value=8,g.value-h.value+s.value))),f=()=>{e.index.navigateTo({url:"/pages/address/edit"})},x=async()=>{if(!u())if(i.value)if(0!==a.value.length)try{if(e.index.showLoading({title:"提交订单中..."}),"buyNow"===c.value){const t=a.value[0];let n=parseFloat(t.price);if(h.value>0){n*=1-h.value/g.value}const l={productId:t.productId,skuId:t.skuId||null,addressBookId:i.value.id,quantity:t.quantity,phoneNumber:i.value.phone};console.log("直接购买请求数据:",l);const s=await o.request({url:"https://bgnc.online/api/order/buyNow",method:"POST",data:l});e.index.hideLoading(),200===s.code?(console.log("result是",s.data),w(s)):b(s)}else{const t={ids:a.value.map((e=>e.originalIds&&e.originalIds.length>0?e.originalIds[0]:e.id)),addressBookId:i.value.id,phoneNumber:i.value.phone};console.log("结算请求数据:",t);const n=await o.request({url:"https://bgnc.online/api/order/settle",method:"POST",data:t});e.index.hideLoading(),200===n.code?(console.log("结算成功:",n),w(n)):b(n)}}catch(t){e.index.hideLoading(),console.error("提交订单失败:",t),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}else e.index.showToast({title:"订单中没有商品",icon:"none"});else e.index.showToast({title:"请选择收货地址",icon:"none"})},w=async t=>{try{console.log("订单创建成功，准备支付:",t);const i=t.data;if(!i)throw new Error("未获取到订单ID");const l=await e.index.login();if(!l.code)throw new Error("获取微信登录code失败");console.log("获取到微信登录code:",l.code);const s=await o.request({url:"https://bgnc.online/api/notify/payment",method:"POST",data:{orderId:i,code:l.code}});if(console.log("获取到支付参数:",s),200!==s.code||!s.data)throw new Error(s.message||"获取支付参数失败");e.index.showLoading({title:"正在拉起支付..."});try{await T(s.data),e.index.showToast({title:"支付成功",icon:"success"});try{await o.request({url:"https://bgnc.online/api/order/",method:"PUT",data:{id:i,status:1}}),console.log("订单状态已更新为待发货")}catch(a){console.error("更新订单状态失败:",a)}setTimeout((()=>{e.index.redirectTo({url:`/pages/order/detail?id=${i}`})}),1500)}catch(n){console.error("支付过程发生错误:",n),n.errMsg&&n.errMsg.includes("cancel")?e.index.showToast({title:"用户取消支付",icon:"none"}):e.index.showToast({title:"支付失败",icon:"none"}),setTimeout((()=>{e.index.redirectTo({url:`/pages/order/detail?id=${i}`})}),1500)}}catch(i){console.error("支付流程出错:",i),e.index.hideLoading(),e.index.showToast({title:i.message||"支付流程出错",icon:"none"}),e.index.removeStorageSync("checkoutItems"),setTimeout((()=>{e.index.switchTab({url:"/pages/user/user"}),setTimeout((()=>{e.index.navigateTo({url:"/pages/order/list"})}),500)}),1500)}finally{e.index.hideLoading()}},T=o=>new Promise(((t,a)=>{e.index.requestPayment({provider:"wxpay",timeStamp:o.timeStamp,nonceStr:o.nonceStr,package:o.packageVal,signType:o.signType,paySign:o.paySign,success:e=>{console.log("支付成功",e),t(e)},fail:e=>{console.log("支付失败",e),a(e)}})})),b=o=>{e.index.showToast({title:o.message||"订单提交失败",icon:"none"})};return e.onShow((()=>{(()=>{try{const o=e.index.getStorageSync("checkoutItems");o&&(a.value=JSON.parse(o))}catch(o){console.error("读取结算数据失败:",o)}})(),d(),(async()=>{try{const e=await o.request({url:"https://bgnc.online/api/user/profile",method:"GET"});200===e.code&&(r.value=e.data.memberLevel||"",console.log("获取到的会员等级:",r.value,"类型:",typeof r.value))}catch(e){console.error("获取会员信息失败:",e)}})()})),e.onMounted((()=>{console.log("结算页面已加载"),d(),(async()=>{try{const e=await o.request({url:"https://bgnc.online/api/discount/",method:"GET"});if(200===e.code&&e.data){const o=e.data.map((e=>({...e,discount:10*parseFloat(e.discount)})));v.value=o}}catch(e){console.error("获取折扣率失败:",e)}})()})),(o,t)=>e.e({a:i.value},i.value?{b:e.p({type:"location",size:"22",color:"#3b78db"}),c:e.t(i.value.consignee),d:e.t(i.value.phone),e:e.t(i.value.provinceName),f:e.t(i.value.cityName),g:e.t(i.value.districtName),h:e.t(i.value.detail),i:e.p({type:"right",size:"16",color:"#ccc"})}:{j:e.p({type:"right",size:"16",color:"#ccc"})},{k:e.o(f),l:e.p({type:"shop",size:"18",color:"#3b78db"}),m:e.f(a.value,((o,t,a)=>e.e({a:o.productImage,b:e.t(o.productName),c:o.spec},o.spec?{d:e.t(o.spec)}:{},{e:e.t(o.price),f:e.t(o.quantity),g:t}))),n:g.value<88},g.value<88?{o:e.t((88-g.value).toFixed(2))}:{},{p:e.t(g.value.toFixed(2)),q:s.value>0},s.value>0?{r:e.t(s.value.toFixed(2))}:{},{s:h.value>0},h.value>0?{t:e.t(m.value),v:e.t(h.value.toFixed(2))}:{},{w:l.value,x:e.o((e=>l.value=e.detail.value)),y:e.t(y.value.toFixed(2)),z:e.o(x)})}};wx.createPage(t);

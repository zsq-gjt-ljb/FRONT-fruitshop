"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const o={__name:"cart",setup(o){const n=e.ref([]),i=e.ref(!1),a=e.computed((()=>0!==n.value.length&&n.value.every((e=>e.selected)))),s=e.computed((()=>n.value.filter((e=>e.selected)).length)),c=e.computed((()=>n.value.filter((e=>e.selected)).reduce(((e,t)=>e+parseFloat(t.price)*t.quantity),0)));e.computed((()=>Math.floor(c.value))),e.computed((()=>{const e=Math.round(100*(c.value-Math.floor(c.value)));return e<10?`0${e}`:e}));const d=async()=>{try{i.value=!0,e.index.showLoading({title:"加载中"});const o=await t.request({url:"https://bgnc.online/api/cart/list",method:"GET"});if(console.log("购物车API返回:",o),200===o.code){const e={};(o.data||[]).map((e=>({id:e.id,productId:e.productId,skuId:e.skuId,productName:e.productName||"未命名商品",productImage:e.productPic||"/static/images/product-default.png",price:e.price||"0",quantity:e.quantity||1,stock:e.stock||999,spec:e.spec||"",selected:!0,originalIds:[e.id]}))).forEach((t=>{const o=`${t.productId}-${t.skuId}`;e[o]?(e[o].quantity+=t.quantity,e[o].originalIds.push(t.id)):e[o]=t})),n.value=Object.values(e),console.log("处理后的购物车数据:",n.value)}else e.index.showToast({title:o.message||"获取购物车失败",icon:"none"})}catch(o){console.error("获取购物车出错:",o),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}finally{i.value=!1,e.index.hideLoading(),e.index.stopPullDownRefresh()}},u=()=>{const e=!a.value;n.value.forEach((t=>{t.selected=e}))},l=()=>{if(p())return;const t=n.value.filter((e=>e.selected));if(0===t.length)return void e.index.showToast({title:"请选择要结算的商品",icon:"none"});const o=t.map((e=>({id:e.id,productId:e.productId,productName:e.productName,productImage:e.productImage,price:e.price,quantity:e.quantity,skuId:e.skuId||"",spec:e.spec||"",originalIds:e.originalIds||[e.id]})));e.index.setStorageSync("checkoutItems",JSON.stringify(o)),e.index.navigateTo({url:"/pages/checkout/checkout"})},r=()=>{e.index.switchTab({url:"/pages/index/index"})};e.onShow((()=>{p()||d()})),e.onPullDownRefresh((()=>{p()?e.index.stopPullDownRefresh():d()})),e.onLoad((()=>{console.log("购物车页面加载"),p()}));const p=()=>{const t=e.index.getStorageSync("isGuestMode"),o=e.index.getStorageSync("token");return!(!t||o)&&(e.index.showModal({title:"需要登录",content:"查看购物车需要登录，是否立即登录？",success:t=>{if(t.confirm){const t="/"+getCurrentPages()[getCurrentPages().length-1].route;e.index.navigateTo({url:"/pages/login/login?redirect="+encodeURIComponent(t)})}else e.index.switchTab({url:"/pages/index/index"})}}),!0)};return(o,i)=>e.e({a:0===n.value.length},0===n.value.length?{b:e.p({type:"cart",size:"64",color:"#ddd"}),c:e.o(r)}:{d:e.t(n.value.length),e:e.f(n.value,((o,i,a)=>e.e({a:o.selected},o.selected?{b:"702118b1-1-"+a,c:e.p({type:"checkmarkempty",size:"14",color:"#fff"})}:{},{d:o.selected?1:"",e:e.o((e=>(e=>{e.selected=!e.selected})(o)),o.id),f:o.productImage||"/static/images/product-default.png",g:e.t(o.productName),h:o.spec},o.spec?{i:e.t(o.spec)}:{},{j:e.t(o.price),k:"702118b1-2-"+a,l:e.p({type:"minus",size:"12",color:o.quantity<=1?"#ccc":"#333"}),m:o.quantity<=1?1:"",n:e.o((n=>(async o=>{if(!(o.quantity<=1))try{o.quantity--;const n=o.originalIds[0],i=await t.request({url:"https://bgnc.online/api/cart/update",method:"PUT",data:{id:n,quantity:o.quantity}});200!==i.code&&(o.quantity++,e.index.showToast({title:i.message||"更新失败",icon:"none"}))}catch(n){console.error("减少数量失败:",n),o.quantity++,e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}})(o)),o.id),o:e.o((n=>(async o=>{const n=o.quantity;if(isNaN(o.quantity)||o.quantity<1?o.quantity=1:o.quantity>o.stock&&(o.quantity=o.stock),n!==o.quantity)try{const n=o.originalIds[0],i=await t.request({url:"https://bgnc.online/api/cart/update",method:"PUT",data:{id:n,quantity:o.quantity}});200!==i.code&&e.index.showToast({title:i.message||"更新失败",icon:"none"})}catch(i){console.error("更新数量失败:",i),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}})(o)),o.id),p:e.o((()=>{}),o.id),q:o.quantity,r:e.o(e.m((e=>o.quantity=e.detail.value),{number:!0}),o.id),s:"702118b1-3-"+a,t:e.p({type:"plus",size:"12",color:o.quantity>=o.stock?"#ccc":"#333"}),v:o.quantity>=o.stock?1:"",w:e.o((n=>(async o=>{if(o.quantity>=o.stock)e.index.showToast({title:"已达最大库存",icon:"none"});else try{o.quantity++;const n=o.originalIds[0],i=await t.request({url:"https://bgnc.online/api/cart/update",method:"PUT",data:{id:n,quantity:o.quantity}});200!==i.code&&(o.quantity--,e.index.showToast({title:i.message||"更新失败",icon:"none"}))}catch(n){console.error("增加数量失败:",n),o.quantity--,e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}})(o)),o.id),x:e.o((t=>{var n;(n=o.productId)&&e.index.navigateTo({url:`/pages/detail/detail?id=${n}`})}),o.id),y:"702118b1-4-"+a,z:e.o((i=>(o=>{e.index.showModal({title:"提示",content:"确定要删除此商品吗？",success:async i=>{if(i.confirm)try{const i=o.originalIds[0],a=await t.request({url:`https://bgnc.online/api/cart/${i}`,method:"DELETE"});if(200===a.code){const t=n.value.findIndex((e=>e.originalIds.includes(i)));-1!==t&&n.value.splice(t,1),e.index.showToast({title:"删除成功",icon:"success"})}else e.index.showToast({title:a.message||"删除失败",icon:"none"})}catch(a){console.error("删除购物车商品失败:",a),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}}})})(o)),o.id),A:o.id}))),f:e.p({type:"trash",size:"18",color:"#fff"})},{g:n.value.length>0},n.value.length>0?e.e({h:a.value},a.value?{i:e.p({type:"checkmarkempty",size:"14",color:"#fff"})}:{},{j:a.value?1:"",k:e.o(u),l:e.t(c.value.toFixed(2)),m:s.value},s.value?{n:e.t(s.value)}:{},{o:s.value>0?1:"",p:e.o(l)}):{})}};wx.createPage(o);

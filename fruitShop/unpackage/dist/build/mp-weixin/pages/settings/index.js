"use strict";const e=require("../../common/vendor.js"),o=require("../../utils/request.js"),t=require("../../utils/loginCheck.js");if(!Array){(e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-popup/uni-popup.js"))();const a={__name:"index",setup(a){const s=e.ref({userAvatar:"",userName:"",phone:"",userSex:0,userBirthday:"",userRole:"",memberLevel:0}),n=e.computed((()=>({0:"未知",1:"男",2:"女"}[s.value.userSex]||"未知"))),r=e.ref(null),i=e.ref(null),l=e.ref(null),u=e.ref([]),c=e.ref([]),d=e.ref([]),p=e.ref([0,0,0]),h=e.ref(""),m=e=>{const o=e.detail.value;p.value=o;const t=u.value[o[0]],a=c.value[o[1]];((e,o)=>{const t=new Date(e,o,0).getDate();d.value=Array.from({length:t},((e,o)=>o+1))})(t,a);const s=d.value[o[2]]||1;h.value=`${t}-${a.toString().padStart(2,"0")}-${s.toString().padStart(2,"0")}`},v=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async t=>{try{const a=t.tempFilePaths[0];e.index.showLoading({title:"上传中...",mask:!0});const n=()=>new Promise(((o,t)=>{e.index.uploadFile({url:"https://bgnc.online/api/file/upload",filePath:a,name:"file",header:{Authorization:`Bearer ${e.index.getStorageSync("token")}`},success:e=>{console.log("上传成功, 原始响应:",e);try{const a="string"==typeof e.data?JSON.parse(e.data):e.data;200===a.code?o(a.msg):t(new Error(a.msg||"上传失败"))}catch(a){t(new Error("响应解析失败"))}},fail:e=>{console.error("上传失败:",e),t(new Error("网络错误"))}})})),r=await n();console.log("头像上传成功, URL:",r);const i=await o.request({url:"https://bgnc.online/api/user/profile",method:"PUT",data:{userAvatar:r}});if(200!==i.code)throw new Error(i.msg||"头像更新失败");s.value.userAvatar=r,e.index.setStorageSync("userAvatar",r),e.index.showToast({title:"头像更新成功",icon:"success"})}catch(a){console.error("头像更新错误:",a),e.index.showToast({title:a.message||"头像更新失败",icon:"none"})}finally{e.index.hideLoading()}}})},g=()=>{r.value.open()},f=async t=>{try{const a=await o.request({url:"https://bgnc.online/api/user/profile",method:"PUT",data:{userName:t}});200===a.code?(s.value.userName=t,e.index.showToast({title:"姓名修改成功",icon:"success"})):e.index.showToast({title:a.msg||"姓名修改失败",icon:"none"})}catch(a){console.error("更新姓名错误:",a),e.index.showToast({title:"姓名修改失败",icon:"error"})}},w=()=>{e.index.showActionSheet({itemList:["男","女"],success:async t=>{const a=t.tapIndex+1;try{200===(await o.request({url:"https://bgnc.online/api/user/profile",method:"PUT",data:{userSex:a}})).code&&(s.value.userSex=a,e.index.showToast({title:"性别修改成功",icon:"success"}))}catch(n){e.index.showToast({title:"性别修改失败",icon:"error"})}}})},x=()=>{i.value.open()},y=async t=>{if(/^1[3-9]\d{9}$/.test(t))try{200===(await o.request({url:"https://bgnc.online/api/user/profile",method:"PUT",data:{phone:t}})).code&&(s.value.phone=t,e.index.showToast({title:"手机号修改成功",icon:"success"}))}catch(a){e.index.showToast({title:"手机号修改失败",icon:"error"})}else e.index.showToast({title:"请输入正确的手机号",icon:"none"})},T=()=>{l.value.close()},b=async()=>{try{const t=await o.request({url:"https://bgnc.online/api/user/profile",method:"PUT",data:{userBirthday:h.value}});200===t.code?(s.value.userBirthday=h.value,e.index.showToast({title:"生日修改成功",icon:"success"})):e.index.showToast({title:t.msg||"生日修改失败",icon:"none"})}catch(t){console.error("更新生日出错:",t),e.index.showToast({title:"生日修改失败",icon:"error"})}finally{l.value.close()}},S=()=>{e.index.showModal({title:"提示",content:"确认退出登录？",success:e=>{e.confirm&&t.loginCheck.logout()}})};return e.onMounted((()=>{(async()=>{try{const e=await o.request({url:"https://bgnc.online/api/user/profile",method:"GET"});200===e.code&&(console.log("res.data是",e),s.value=e.data)}catch(e){console.error("获取用户信息失败：",e)}})()})),(o,t)=>({a:s.value.userAvatar||"/static/images/default-avatar.png",b:e.o(v),c:e.t(s.value.userName||"未设置"),d:e.o(g),e:e.t(s.value.phone||"未绑定"),f:e.o(x),g:e.t(n.value),h:e.o(w),i:e.o(S),j:e.o(f),k:e.p({mode:"input",title:"修改姓名",placeholder:"请输入姓名",value:s.value.userName}),l:e.sr(r,"95edf658-0",{k:"nameDialog"}),m:e.p({type:"dialog"}),n:e.o(y),o:e.p({mode:"input",title:"修改手机号",placeholder:"请输入手机号",value:s.value.phone}),p:e.sr(i,"95edf658-2",{k:"phoneDialog"}),q:e.p({type:"dialog"}),r:e.o(T),s:e.o(b),t:e.f(u.value,((o,t,a)=>({a:e.t(o),b:t}))),v:e.f(c.value,((o,t,a)=>({a:e.t(o),b:t}))),w:e.f(d.value,((o,t,a)=>({a:e.t(o),b:t}))),x:p.value,y:e.o(m),z:e.sr(l,"95edf658-4",{k:"datePopup"}),A:e.p({type:"bottom"})})}};wx.createPage(a);

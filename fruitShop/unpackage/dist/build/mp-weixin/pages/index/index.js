"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),o=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math||((()=>"../../node-modules/@dcloudio/uni-ui/lib/uni-icons/uni-icons.js")+t)();const t=()=>"../../components/FloatingContact.js",l={__name:"index",setup(t,{expose:l}){const c=e.ref([]),i=e.ref([]),s=e.ref([]),n=e.ref(!1),u=async()=>{n.value=!0;try{console.log("开始初始化首页数据"),await(async()=>{try{console.log("开始加载轮播图数据");const e=await o.request({url:"https://bgnc.online/api/product/market/1",method:"GET"});console.log("轮播图API返回结果:",e),200===e.code?(console.log("轮播图数据:",e.data),c.value=(e.data||[]).map((e=>({id:e.id,productId:e.id,name:e.productName||"",indexPic:e.indexPic||""}))),console.log("处理后的轮播图数据:",c.value)):(console.error("获取轮播图失败:",e.message),c.value=[])}catch(e){console.error("加载轮播图出错:",e),c.value=[]}})(),await(async()=>{try{console.log("开始加载分类数据");const e=await o.request({url:"https://bgnc.online/api/category/list",method:"GET"});if(console.log("分类API返回结果:",e),200===e.code){console.log("分类数据:",e.data),i.value=e.data||[];const a=["/static/images/category-fruit.png","/static/images/category-tea.png","/static/images/category-leaf.png","/static/images/category-dried.png","/static/images/category-snack.png","/static/images/category-digi.png","/static/images/category-gift.png","/static/images/category-feature.png"];i.value=i.value.map(((e,o)=>({...e,image:a[o%a.length]}))),console.log("处理后的分类数据:",i.value)}else console.error("获取分类失败:",e.message),i.value=[]}catch(e){console.error("加载分类出错:",e),i.value=[]}})(),await(async()=>{try{console.log("开始加载首页推荐商品");const e=await o.request({url:"https://bgnc.online/api/product/market/0",method:"GET"});console.log("首页商品API返回结果:",e),200===e.code?(console.log("首页商品数据:",e.data),s.value=(e.data||[]).map((e=>({id:e.id,productId:e.id,name:e.name||"",indexPic:e.indexPic||"",price:e.price||"暂无价格"}))),console.log("处理后的首页商品数据:",s.value)):(console.error("获取首页商品失败:",e.message),s.value=[])}catch(e){console.error("加载首页商品出错:",e),s.value=[]}})(),console.log("首页数据加载完成")}catch(a){console.error("初始化数据失败:",a),e.index.showToast({title:"加载数据失败",icon:"none"})}finally{n.value=!1}},r=a=>{if(!a)return void console.error("无效的商品ID");console.log("首页跳转到商品详情，ID:",a);const o="object"==typeof a?a.id:a;e.index.navigateTo({url:`/pages/detail/detail?id=${o}`,success:e=>{console.log("跳转成功:",e)},fail:a=>{console.error("跳转失败:",a),e.index.navigateTo({url:"/pages/detail/detail",success:function(e){e.eventChannel.emit("acceptDataFromOpener",{id:o})}})}})},v=a=>{var o,t;o=a.id,t=a.name,console.log("跳转到分类页面:",o,t),e.index.setStorageSync("selectedCategoryId",o),e.index.switchTab({url:"/pages/category/category"})},d=()=>{e.index.removeStorageSync("selectedCategoryId"),e.index.switchTab({url:"/pages/category/category"})};e.onMounted((()=>{console.log("首页组件已挂载"),u()}));const g=e.ref(!1),p=e.ref({}),m=e.ref(0),f=e.ref(1),y=e.computed((()=>p.value.specs&&p.value.specs.length>0?p.value.specs[m.value].name:"默认规格")),h=()=>{g.value=!1},k=e=>{if(m.value=e,S.value[e]&&(y.value=S.value[e].name,_.value.length>0)){const a=_.value.find((a=>a.spData.includes(S.value[e].id+":"+S.value[e].value)));a&&(q.value.price=a.price,q.value.stock=a.stock,D.value=a.id,f.value>a.stock&&(f.value=a.stock>0?a.stock:1))}},x=()=>{f.value<(p.value.stock||999)&&f.value++},b=()=>{f.value>1&&f.value--},w=()=>{const e=p.value.stock||999;isNaN(f.value)||f.value<1?f.value=1:f.value>e&&(f.value=e)},I=async()=>{if(D.value)try{const a={skuId:D.value,productId:q.value.id,quantity:f.value};console.log("添加到购物车数据:",a);const t=await o.request({url:"https://bgnc.online/api/cart/add",method:"POST",data:a});200===t.code?(e.index.showToast({title:"已添加到购物车",icon:"success"}),j()):e.index.showToast({title:t.message||"添加失败",icon:"none"})}catch(a){console.error("添加到购物车出错:",a),e.index.showToast({title:"网络错误，请重试",icon:"none"})}else e.index.showToast({title:"请选择有效的规格",icon:"none"})},P=()=>{if(!y)return p.value=a,m.value=0,f.value=1,void(g.value=!0);var a;const o={productId:q.value.id,productName:q.value.name,productImage:q.value.indexPic,price:q.value.price,quantity:f.value,skuId:D.value||"",spec:y.value||""};e.index.setStorageSync("checkoutItems",JSON.stringify([o])),e.index.navigateTo({url:"/pages/checkout/checkout?type=buyNow"})},T=e.ref(!1),q=e.ref({}),S=e.ref([]),_=e.ref([]),D=e.ref(""),j=()=>{T.value=!1},A=()=>{console.log("联系客服事件被触发")};return l({onShareAppMessage:e=>{var a;return{title:"北果南茶 - 新鲜水果，健康生活",path:"/pages/index/index",imageUrl:(null==(a=s.value[0])?void 0:a.indexPic)||"/static/images/share.png"}},onShareTimeline:()=>{var e;return{title:"北果南茶 - 新鲜水果，健康生活",query:"",imageUrl:(null==(e=s.value[0])?void 0:e.indexPic)||"/static/images/share.png"}}}),(t,l)=>e.e({a:e.f(c.value,((a,o,t)=>({a:a.indexPic,b:e.t(a.name),c:a.id,d:e.o((e=>r(a.productId)),a.id)}))),b:a._imports_0,c:a._imports_1,d:a._imports_2,e:e.o(d),f:e.f(i.value.slice(0,8),((a,o,t)=>({a:a.image||"/static/images/category-default.png",b:e.t(a.name),c:a.id,d:e.o((e=>v(a)),a.id)}))),g:e.f(s.value,((a,t,l)=>e.e({a:a.indexPic,b:t<2},{},{c:e.t(a.name),d:e.t(a.price||"暂无价格"),e:"2d1fa052-0-"+l,f:e.o((e=>(async e=>{console.log("显示快速购买弹窗:",e),q.value={...e,stock:0},m.value=0,f.value=1,S.value=[],_.value=[],D.value="";try{const a=await o.request({url:`https://bgnc.online/api/product/${e.id}`,method:"GET"});if(200===a.code&&a.data)if(console.log("获取到商品详情:",a.data),a.data.skuList&&a.data.skuList.length>0){_.value=a.data.skuList;const e=new Map;if(a.data.skuList.forEach((a=>{a.spData&&a.spData.split(";").forEach((o=>{const[t,l]=o.split(":");e.has(l)||e.set(l,{id:t,value:l,name:`规格${l}`,price:a.price,stock:a.stock,skuId:a.id})}))})),S.value=Array.from(e.values()),S.value.length>0){y.value=S.value[0].name;const e=_.value.find((e=>e.spData.includes(S.value[0].id+":"+S.value[0].value)));e&&(q.value.stock=e.stock,q.value.price=e.price,D.value=e.id)}else _.value[0]&&(q.value.stock=_.value[0].stock,q.value.price=_.value[0].price,D.value=_.value[0].id,y.value="默认规格")}else S.value=[{name:"默认规格",price:e.price,stock:100}],y.value="默认规格",q.value.stock=100}catch(a){console.error("获取商品详情失败:",a),S.value=[{name:"默认规格",price:e.price,stock:100}],y.value="默认规格",q.value.stock=100}T.value=!0})(a)),a.id),g:a.id,h:e.o((e=>r(a.productId)),a.id)}))),h:e.p({type:"cart",size:"16",color:"#fff"}),i:e.o(A),j:e.p({bottom:150,right:30}),k:g.value},g.value?e.e({l:e.o(h),m:p.value.image,n:e.t(p.value.price),o:p.value.originalPrice},p.value.originalPrice?{p:e.t(p.value.originalPrice)}:{},{q:e.t(p.value.stock||0),r:e.t(y.value),s:e.p({type:"closeempty",size:"20",color:"#999"}),t:e.o(h),v:e.f(p.value.specs,((a,o,t)=>({a:e.t(a.name),b:o,c:e.n(m.value===o?"active":""),d:e.o((e=>k(o)),o)}))),w:e.n(f.value<=1?"disabled":""),x:e.o(b),y:e.o(w),z:f.value,A:e.o(e.m((e=>f.value=e.detail.value),{number:!0})),B:e.n(f.value>=p.value.stock?"disabled":""),C:e.o(x),D:e.o(I),E:e.o(P)}):{},{F:T.value},T.value?{G:e.o(j),H:q.value.indexPic,I:e.t(q.value.price),J:e.t(q.value.stock||1e3),K:e.t(y.value),L:e.p({type:"close",size:"16",color:"#666"}),M:e.o(j),N:e.f(S.value,((a,o,t)=>e.e({a:e.t(a.name),b:a.price},a.price?{c:e.t(a.price)}:{},{d:void 0!==a.stock},void 0!==a.stock?{e:e.t(a.stock)}:{},{f:o,g:e.n(m.value===o?"active":""),h:e.o((e=>k(o)),o)}))),O:e.o(b),P:e.o(w),Q:f.value,R:e.o(e.m((e=>f.value=e.detail.value),{number:!0})),S:e.o(x),T:e.o(I),U:e.o(P)}:{})},__runtimeHooks:6};wx.createPage(l);

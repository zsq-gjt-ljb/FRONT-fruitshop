"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/request.js");if(!Array){e.resolveComponent("uni-icons")()}Math;const t={__name:"detail",setup(t){const o=e.ref(""),l=e.ref([]),i=e.ref({}),n=e.ref([]),s=e.ref([]),u=e.ref(0),c=e.ref("默认规格"),r=e.ref(1),v=e.ref(!1),d=e.ref({}),p=e.ref(""),h=e.ref(!0),g=new Map,m=()=>{const a=e.index.getStorageSync("isGuestMode"),t=e.index.getStorageSync("token");return!(!a||t)&&(e.index.showModal({title:"需要登录",content:"该功能需要登录后才能使用，是否立即登录？",success:a=>{if(a.confirm){const a="/"+getCurrentPages()[getCurrentPages().length-1].route,t=getCurrentPages()[getCurrentPages().length-1].options;let o=a;if(t&&Object.keys(t).length>0){o=`${a}?${Object.keys(t).map((e=>`${e}=${t[e]}`)).join("&")}`}e.index.navigateTo({url:"/pages/login/login?redirect="+encodeURIComponent(o)})}}}),!0)},f=async t=>{if(!t)return e.index.showToast({title:"商品ID无效",icon:"none"}),void(h.value=!1);h.value=!0,console.log(`尝试获取商品数据，ID=${t}`);try{console.log("正在获取商品详情, ID:",t);const o=await a.request({url:`https://bgnc.online/api/product/${t}`,method:"GET"});console.log("API返回结果:",o),200===o.code&&o.data?(console.log("获取到商品详情:",o.data),i.value=o.data,l.value=[],o.data.indexPic&&l.value.push(o.data.indexPic),o.data.albumPicsList&&o.data.albumPicsList.length>0&&o.data.albumPicsList.forEach((e=>{e!==o.data.indexPic&&l.value.push(e)})),0===l.value.length&&l.value.push("/static/images/product-default.png"),n.value=o.data.skuList||[],(e=>{try{if(console.log("开始处理SKU数据:",e),s.value=[],g.clear(),!e||0===e.length)return s.value=[{name:"默认规格",price:i.value.price,stock:100,skuId:""}],d.value={price:i.value.price,stock:100,id:""},void(c.value="默认规格");e.forEach((e=>{if(console.log("处理SKU项:",e),e.spData)e.spData.split(";").forEach((a=>{const[t,o]=a.split(":"),l=`${t}:${o}`;if(!g.has(l)){const a={id:t,value:o,name:`规格${o}`,price:e.price,stock:e.stock,skuId:e.id};g.set(l,a),s.value.push(a)}}));else{const a={name:"默认规格",price:e.price,stock:e.stock,skuId:e.id};0===s.value.length&&s.value.push(a)}})),s.value.length>0&&(c.value=s.value[0].name,p.value=s.value[0].skuId,d.value={price:s.value[0].price,stock:s.value[0].stock,id:s.value[0].skuId}),console.log("处理后的规格数据:",s.value)}catch(a){console.error("处理SKU数据出错:",a),s.value=[{name:"默认规格",price:i.value.price,stock:100}],c.value="默认规格"}})(o.data.skuList||[]),console.log("处理后的商品数据:",{images:l.value,info:i.value,specs:s.value,currentSku:d.value})):e.index.showToast({title:"获取商品详情失败",icon:"none"})}catch(o){console.error("获取商品详情出错:",o),e.index.showToast({title:"网络错误",icon:"none"})}finally{h.value=!1}};e.onLoad((a=>{console.log("详情页收到参数:",a),a.id?(o.value=a.id,f(a.id)):(console.error("没有收到有效的商品ID"),e.index.showToast({title:"商品ID无效",icon:"none"}),h.value=!1),e.index.showShareMenu({withShareTicket:!0,menus:["shareAppMessage","shareTimeline"]})}));const k=()=>{e.index.navigateBack()},x=()=>{e.index.switchTab({url:"/pages/index/index"})},y=()=>{e.index.switchTab({url:"/pages/cart/cart"})},w=()=>{v.value=!0},I=()=>{v.value=!1},T=()=>{r.value>1&&r.value--},b=()=>{r.value<d.value.stock?r.value++:e.index.showToast({title:"已达最大库存",icon:"none"})},P=()=>{const e=parseInt(r.value);isNaN(e)||e<1?r.value=1:e>d.value.stock?r.value=d.value.stock>0?d.value.stock:1:r.value=e},S=async()=>{if(!m())if(p.value)try{const t=await a.request({url:"https://bgnc.online/api/cart/add",method:"POST",data:{skuId:p.value,productId:o.value,quantity:r.value}});200===t.code?(e.index.showToast({title:"已加入购物车",icon:"success"}),I()):e.index.showToast({title:t.message||"添加失败",icon:"none"})}catch(t){console.error("添加购物车失败:",t),e.index.showToast({title:"网络错误，请稍后再试",icon:"none"})}else e.index.showToast({title:"请选择规格",icon:"none"})},L=async()=>{var t;if(m())return;if(!c&&i.value.hasSpecs)return void w();let o="";try{const e=await a.request({url:"https://bgnc.online/api/user/profile",method:"GET"});200===e.code&&(o=e.data.memberLevel||"")}catch(u){console.error("获取会员信息失败:",u)}let n=parseFloat((null==(t=d.value)?void 0:t.price)||i.value.price);const s={productId:i.value.id,productName:i.value.name,productImage:l.value[0],price:n,quantity:r.value,skuId:p.value||"",spec:c.value||"",memberLevel:o};e.index.setStorageSync("checkoutItems",JSON.stringify([s])),e.index.navigateTo({url:"/pages/checkout/checkout?type=buyNow"})},$=()=>{try{e.index.showLoading({title:"生成分享图片..."});i.value.name,i.value.price,l.value[0],o.value;e.index.canvasToTempFilePath({canvasId:"shareCanvas",success:function(a){const t=a.tempFilePath;e.index.saveImageToPhotosAlbum({filePath:t,success:function(){e.index.hideLoading(),e.index.showModal({title:"分享提示",content:"分享图片已保存到相册，可前往分享给好友",showCancel:!1})},fail:function(){e.index.hideLoading(),e.index.showModal({title:"分享提示",content:"请先授权保存图片到相册的权限",showCancel:!1})}})},fail:function(a){console.error("生成分享图片失败",a),e.index.hideLoading(),e.index.showToast({title:"请点击右上角进行分享",icon:"none"})}})}catch(a){console.error("分享功能出错:",a),e.index.hideLoading(),e.index.showToast({title:"请点击右上角进行分享",icon:"none"})}};e.onShareAppMessage((()=>{var e;return{title:(null==(e=i.value)?void 0:e.name)||"好物推荐",path:`/pages/detail/detail?id=${o.value}`,imageUrl:l.value[0]}}));try{e.onShareTimeline((()=>{var e;return{title:(null==(e=i.value)?void 0:e.name)||"好物推荐",query:`id=${o.value}`,imageUrl:l.value[0]}}))}catch(M){console.log("分享到朋友圈功能不可用")}const q=()=>{m()||w()},C=()=>{m()||w()};return(a,t)=>e.e({a:h.value},h.value?{}:e.e({b:e.p({type:"back",size:"20",color:"#fff"}),c:e.o(k),d:e.f(l.value,((e,a,t)=>({a:e,b:a}))),e:e.t(i.value.price),f:i.value.originalPrice},i.value.originalPrice?{g:e.t(i.value.originalPrice)}:{},{h:e.t(i.value.sale||0),i:e.t(i.value.name),j:e.p({type:"redo-filled",size:"24",color:"#4B91F1"}),k:e.o($),l:e.t(i.value.description||"暂无商品描述"),m:e.t(c.value||"请选择"),n:e.p({type:"right",size:"16",color:"#ccc"}),o:e.o(w),p:i.value.detailHtml||"<p>暂无详情</p>",q:e.p({type:"home",size:"24",color:"#666"}),r:e.o(x),s:e.p({type:"cart",size:"24",color:"#666"}),t:e.o(y),v:e.o(q),w:e.o(C),x:v.value},v.value?{y:e.o(I),z:l.value[0],A:e.t(d.value.price||i.value.price),B:e.t(d.value.stock||0),C:e.t(c.value),D:e.p({type:"closeempty",size:"20",color:"#999"}),E:e.o(I),F:e.f(s.value,((a,t,o)=>e.e({a:e.t(a.name),b:a.price},a.price?{c:e.t(a.price)}:{},{d:void 0!==a.stock},void 0!==a.stock?{e:e.t(a.stock)}:{},{f:t,g:e.n(u.value===t?"active":""),h:e.o((e=>(e=>{e<0||e>=s.value.length||(u.value=e,c.value=s.value[e].name,p.value=s.value[e].skuId,d.value={price:s.value[e].price,stock:s.value[e].stock,id:s.value[e].skuId},i.value.price=d.value.price,r.value>d.value.stock&&(r.value=d.value.stock>0?d.value.stock:1))})(t)),t)}))),G:e.n(r.value<=1?"disabled":""),H:e.o(T),I:e.o(P),J:r.value,K:e.o(e.m((e=>r.value=e.detail.value),{number:!0})),L:e.n(r.value>=d.value.stock?"disabled":""),M:e.o(b),N:e.o(S),O:e.o(L)}:{}))},__runtimeHooks:6};wx.createPage(t);

{"version":3,"file":"wxpay.js","sources":["utils/wxpay.js"],"sourcesContent":["/**\r\n * 微信支付相关函数\r\n */\r\nimport request from './request'\r\n\r\n/**\r\n * 微信支付主函数\r\n * @param {string} goodId - 商品ID，用于创建订单\r\n * @returns {Promise<object>} - 返回支付结果\r\n */\r\nexport async function wxPay(orderId) {\r\n  try {\r\n    // 1. 获取orderId（如果没有传入，则需要创建订单）\r\n    if (!orderId) {\r\n      throw new Error('订单ID不能为空')\r\n    }\r\n\r\n    // 2. 获取 code\r\n    const code = await wxLogin()\r\n\r\n    // 3. 请求微信支付所需数据\r\n    const payData = await ajax(\"POST\", \"/api/order/wxXcxPay\", {\r\n      orderId,\r\n      code,\r\n    })\r\n\r\n    // 4. 发起支付\r\n    const res = await payment(payData)\r\n\r\n    // 5. 判断是否支付成功\r\n    let payResult = res.errMsg\r\n    if (payResult == \"requestPayment:ok\") {\r\n      // 支付成功\r\n      return { success: true, message: '支付成功' }\r\n    } else if (payResult == \"requestPayment:fail cancel\") {\r\n      // 用户取消支付\r\n      return { success: false, message: '用户取消支付', canceled: true }\r\n    } else {\r\n      // 支付失败\r\n      return { success: false, message: '支付失败' }\r\n    }\r\n  } catch (error) {\r\n    console.error('微信支付异常:', error)\r\n    return { success: false, message: error.message || '支付过程发生错误' }\r\n  }\r\n}\r\n\r\n/**\r\n * 调用微信登录获取code\r\n * @returns {Promise<string>} - 返回微信登录code\r\n */\r\nfunction wxLogin() {\r\n  return new Promise((resolve, reject) => {\r\n    uni.login({\r\n      provider: 'weixin',\r\n      success: (res) => {\r\n        if (res.code) {\r\n          resolve(res.code)\r\n        } else {\r\n          reject(new Error('获取code失败'))\r\n        }\r\n      },\r\n      fail: (err) => {\r\n        reject(new Error('微信登录失败: ' + JSON.stringify(err)))\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 封装网络请求\r\n * @param {string} method - 请求方法\r\n * @param {string} url - 请求地址\r\n * @param {object} data - 请求数据\r\n * @returns {Promise<object>} - 返回请求结果\r\n */\r\nfunction ajax(method, url, data) {\r\n  return new Promise((resolve, reject) => {\r\n    request({\r\n      url: 'https://bgnc.online' + url,\r\n      method: method,\r\n      data: data\r\n    }).then(result => {\r\n      if (result.code === 200) {\r\n        resolve(result.data)\r\n      } else {\r\n        reject(new Error(result.message || '请求失败'))\r\n      }\r\n    }).catch(error => {\r\n      reject(error)\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 调用微信支付API\r\n * @param {object} payData - 微信支付所需参数\r\n * @returns {Promise<object>} - 返回支付结果\r\n */\r\nfunction payment(payData) {\r\n  return new Promise((resolve, reject) => {\r\n    uni.requestPayment({\r\n      provider: 'wxpay',\r\n      timeStamp: payData.timeStamp,\r\n      nonceStr: payData.nonceStr,\r\n      package: payData.package,\r\n      signType: payData.signType,\r\n      paySign: payData.paySign,\r\n      success: (res) => {\r\n        resolve(res)\r\n      },\r\n      fail: (err) => {\r\n        resolve(err) // 支付失败也要resolve，因为用户取消支付也算正常流程\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\nexport default {\r\n  wxPay\r\n} "],"names":["uni","request"],"mappings":";;;AAUO,eAAe,MAAM,SAAS;AACnC,MAAI;AAEF,QAAI,CAAC,SAAS;AACZ,YAAM,IAAI,MAAM,UAAU;AAAA,IAC3B;AAGD,UAAM,OAAO,MAAM,QAAS;AAG5B,UAAM,UAAU,MAAM,KAAK,QAAQ,uBAAuB;AAAA,MACxD;AAAA,MACA;AAAA,IACN,CAAK;AAGD,UAAM,MAAM,MAAM,QAAQ,OAAO;AAGjC,QAAI,YAAY,IAAI;AACpB,QAAI,aAAa,qBAAqB;AAEpC,aAAO,EAAE,SAAS,MAAM,SAAS,OAAQ;AAAA,IAC/C,WAAe,aAAa,8BAA8B;AAEpD,aAAO,EAAE,SAAS,OAAO,SAAS,UAAU,UAAU,KAAM;AAAA,IAClE,OAAW;AAEL,aAAO,EAAE,SAAS,OAAO,SAAS,OAAQ;AAAA,IAC3C;AAAA,EACF,SAAQ,OAAO;AACdA,kBAAAA,MAAA,MAAA,SAAA,wBAAc,WAAW,KAAK;AAC9B,WAAO,EAAE,SAAS,OAAO,SAAS,MAAM,WAAW,WAAY;AAAA,EAChE;AACH;AAMA,SAAS,UAAU;AACjB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCA,kBAAAA,MAAI,MAAM;AAAA,MACR,UAAU;AAAA,MACV,SAAS,CAAC,QAAQ;AAChB,YAAI,IAAI,MAAM;AACZ,kBAAQ,IAAI,IAAI;AAAA,QAC1B,OAAe;AACL,iBAAO,IAAI,MAAM,UAAU,CAAC;AAAA,QAC7B;AAAA,MACF;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,eAAO,IAAI,MAAM,aAAa,KAAK,UAAU,GAAG,CAAC,CAAC;AAAA,MACnD;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;AASA,SAAS,KAAK,QAAQ,KAAK,MAAM;AAC/B,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCC,0BAAQ;AAAA,MACN,KAAK,wBAAwB;AAAA,MAC7B;AAAA,MACA;AAAA,IACN,CAAK,EAAE,KAAK,YAAU;AAChB,UAAI,OAAO,SAAS,KAAK;AACvB,gBAAQ,OAAO,IAAI;AAAA,MAC3B,OAAa;AACL,eAAO,IAAI,MAAM,OAAO,WAAW,MAAM,CAAC;AAAA,MAC3C;AAAA,IACP,CAAK,EAAE,MAAM,WAAS;AAChB,aAAO,KAAK;AAAA,IAClB,CAAK;AAAA,EACL,CAAG;AACH;AAOA,SAAS,QAAQ,SAAS;AACxB,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCD,kBAAAA,MAAI,eAAe;AAAA,MACjB,UAAU;AAAA,MACV,WAAW,QAAQ;AAAA,MACnB,UAAU,QAAQ;AAAA,MAClB,SAAS,QAAQ;AAAA,MACjB,UAAU,QAAQ;AAAA,MAClB,SAAS,QAAQ;AAAA,MACjB,SAAS,CAAC,QAAQ;AAChB,gBAAQ,GAAG;AAAA,MACZ;AAAA,MACD,MAAM,CAAC,QAAQ;AACb,gBAAQ,GAAG;AAAA,MACZ;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;;"}